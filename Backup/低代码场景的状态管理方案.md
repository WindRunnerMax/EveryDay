# ä½ä»£ç åœºæ™¯çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
åœ¨å¤æ‚åº”ç”¨ä¸­ï¼Œä¾‹å¦‚ä½ä»£ç ã€å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„åœºæ™¯ä¸‹ï¼Œæ•°æ®ç»“æ„çš„è®¾è®¡å°±æ˜¾å¾—éå¸¸é‡è¦ï¼Œè¿™ç§æƒ…å†µä¸‹çš„çŠ¶æ€ç®¡ç†å¹¶éæ˜¯`redux`ã€`mobx`ç­‰é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯éœ€è¦é’ˆå¯¹å…·ä½“åœºæ™¯è¿›è¡Œå®šåˆ¶åŒ–è®¾è®¡ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘ä»¬æ¥å°è¯•åŸºäº`Immer`ä»¥åŠ`OT-JSON`å®ç°åŸå­åŒ–ã€å¯ååŒã€é«˜æ‰©å±•çš„åº”ç”¨çº§çŠ¶æ€ç®¡ç†æ–¹æ¡ˆã€‚

## æè¿°
å°†`Immer`ä¸`OT-JSON`ç»“åˆçš„æƒ³æ³•æ¥è‡ªäº`slate`ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹`slate`çš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œä¸‹é¢çš„ä¾‹å­æ˜¯é«˜äº®å—çš„æè¿°ã€‚è¿™ä¸ªæ•°æ®ç»“æ„çœ‹èµ·æ¥éå¸¸åƒé›¶ä»£ç /ä½ä»£ç çš„ç»“æ„ï¼Œå› ä¸ºå…¶å«æœ‰å¾ˆå¤š`children`ï¼Œè€Œä¸”å­˜åœ¨å¯¹èŠ‚ç‚¹çš„è£…é¥°æè¿°ï¼Œå³`bold`ã€`border`ã€`background`ç­‰å±æ€§å€¼ã€‚

```js
[
  {
    "highlight-block": {
      border: "var(--arcoblue-6)",
      background: "var(--arcoblue-3)",
    },
    children: [
      { children: [{ text: "ğŸŒ° " }, { text: "ä¸¾ä¸ªæ —å­", bold: true }] },
      { children: [{ text: "æ”¯æŒé«˜äº®å— å¯ä»¥ç”¨äºæç¤ºæ–‡æ¡£ä¸­çš„é‡è¦å†…å®¹ã€‚" }] },
    ],
  },
];
```

é‚£ä¹ˆè¿™é‡Œçš„è®¾è®¡å°±å¾ˆæœ‰è¶£ï¼Œä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬å°±èŠè¿‡ï¼Œæœ¬è´¨ä¸Šä½ä»£ç å’Œå¯Œæ–‡æœ¬éƒ½æ˜¯åŸºäº`DSL`çš„æè¿°æ¥æ“ä½œ`DOM`ç»“æ„ï¼Œåªä¸è¿‡å¯Œæ–‡æœ¬ä¸»è¦æ˜¯é€šè¿‡é”®ç›˜è¾“å…¥æ¥æ“ä½œ`DOM`ï¼Œè€Œæ— ä»£ç åˆ™æ˜¯é€šè¿‡æ‹–æ‹½ç­‰æ–¹å¼æ¥æ“ä½œ`DOM`ï¼Œè¿™é‡Œå½“ç„¶æ˜¯æœ‰äº›å…±é€šçš„è®¾è®¡æ€è·¯ï¼Œè¿™ä¸ªç»“è®ºå…¶å®å°±æ˜¯æ¥è‡ªäº`slate`çš„çŠ¶æ€ç®¡ç†ã€‚

æœ¬æ–‡å®ç°çš„ç›¸å…³`DEMO`éƒ½åœ¨`https://github.com/WindRunnerMax/webpack-simple-environment/tree/master/packages/immer-ot-json`ä¸­ã€‚

### åŸºæœ¬åŸåˆ™
å‰è¾¹æˆ‘ä»¬ä¹Ÿæåˆ°äº†æ•°æ®ç»“æ„çš„å…·ä½“åœºæ™¯è¿›è¡Œå®šåˆ¶åŒ–è®¾è®¡ï¼Œè¿™éƒ¨åˆ†ä¸»è¦æŒ‡çš„æ˜¯`JSON`çš„ç»“æ„éå¸¸çµæ´»ï¼Œåƒæ˜¯é«˜äº®å—çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è®¾è®¡ä¸ºå•ç‹¬çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å°†å…¶æ‹å¹³ï¼Œä»¥`Map`çš„å½¢å¼æ¥æè¿°èŠ‚ç‚¹çš„è£…é¥°ï¼Œå†ä¾‹å¦‚ä¸Šè¿°æ–‡æœ¬å†…å®¹åˆ™è§„å®šäº†éœ€è¦ç”¨`text`å±æ€§æè¿°ã€‚

åŸå­åŒ–çš„è®¾è®¡éå¸¸é‡è¦ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†åŸå­åŒ–åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç»“æ„çš„åŸå­åŒ–ä¸æ“ä½œçš„åŸå­åŒ–ã€‚ç»“æ„çš„åŸå­åŒ–æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†èŠ‚ç‚¹è‡ªç”±ç»„åˆï¼Œè€Œæ“ä½œçš„åŸå­åŒ–åˆ™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡æè¿°æ¥æ“ä½œèŠ‚ç‚¹çŠ¶æ€ï¼Œè¿™ä¸¤è€…çš„ç»„åˆå¯ä»¥æ–¹ä¾¿åœ°å®ç°ç»„ä»¶æ¸²æŸ“ã€çŠ¶æ€å˜æ›´ã€å†å²æ“ä½œç­‰ç­‰ã€‚

èŠ‚ç‚¹çš„è‡ªç”±ç»„åˆå¯ä»¥åº”ç”¨åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œä¾‹å¦‚è¡¨å•ç»“æ„ä¸­ï¼Œä»»ä½•ä¸€ä¸ªè¡¨å•é¡¹éƒ½å¯ä»¥éƒ½å¯ä»¥å˜ä¸ºå…¶ä»–è¡¨å•é¡¹çš„åµŒå¥—ç»“æ„ï¼Œç»„åˆæ¨¡å¼å¯ä»¥è®¾å®šéƒ¨åˆ†è§„åˆ™æ¥é™åˆ¶ã€‚æ“ä½œçš„åŸå­åŒ–å¯ä»¥æ›´æ–¹ä¾¿åœ°å¤„ç†çŠ¶æ€å˜æ›´ï¼ŒåŒæ ·æ˜¯åœ¨è¡¨å•ä¸­ï¼ŒåµŒå¥—çš„è¡¨å•é¡¹å±•å¼€/æŠ˜å çŠ¶æ€å°±éœ€è¦é€šè¿‡çŠ¶æ€å˜æ›´å®ç°ã€‚

å½“ç„¶ï¼ŒåŸå­åŒ–æ‰§è¡Œæ“ä½œçš„æ—¶å€™å¯èƒ½å¹¶æ²¡æœ‰é‚£ä¹ˆç†æƒ³ï¼Œç»„åˆ`ops`æ¥æ‰§è¡Œæ“ä½œè¡¨è¾¾ç±»ä¼¼`action`èŒƒå¼çš„æ“ä½œä¹Ÿæ˜¯å¾ˆå¸¸è§„çš„æ“ä½œï¼Œè¿™éƒ¨åˆ†å°±æ˜¯éœ€è¦`compose`çš„å¤„ç†æ–¹å¼ã€‚å¹¶ä¸”çŠ¶æ€ç®¡ç†å¯èƒ½å¹¶ä¸æ˜¯éƒ½éœ€è¦æŒä¹…åŒ–ï¼Œåœ¨ä¸´æ—¶çŠ¶æ€ç®¡ç†ä¸­ï¼Œ`client-side-xxx`å±æ€§å¤„ç†å¾ˆå®¹æ˜“å®ç°ï¼Œ`AXY+Z`å€¼å¤„ç†åˆ™ä¼šæ›´åŠ å¤æ‚ã€‚

ååŒç®—æ³•çš„åŸºç¡€åŒæ ·æ˜¯åŸå­åŒ–çš„æ“ä½œï¼Œç±»ä¼¼äº`redux`çš„èŒƒå¼`action`æ“ä½œéå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯å´æ— æ³•å¤„ç†ååŒå†²çªï¼ŒåŒæ ·ä¹Ÿä¸å®¹æ˜“å¤„ç†å†å²æ“ä½œç­‰ã€‚è¿™ä¸€å±€é™æ€§æºäºå…¶å•å‘ã€ç¦»æ•£çš„æ“ä½œæ¨¡å‹ï¼Œæ¯ä¸ª`action`ä»…è¡¨è¾¾ç‹¬ç«‹æ„å›¾ï¼Œè€Œç¼ºä¹å¯¹å…¨å±€çŠ¶æ€å› æœå…³ç³»(æ“ä½œ`A`å½±å“æ“ä½œ`B`çŠ¶æ€)çš„æ˜¾å¼ç»´æŠ¤ã€‚

`OT-JSON`åˆ™å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†åŸå­åŒ–çš„æ“ä½œï¼Œæ‰©å±•åˆ°ååŒç¼–è¾‘çš„å¤æ‚åœºæ™¯ä¸­ï¼Œé€šè¿‡å¼•å…¥æ“ä½œå˜æ¢`OT`ï¼Œä»¥æ­¤æ¥è§£å†³å†²çªã€‚å½“ç„¶ä»…ä»…æ˜¯å‰ç«¯å¼•å…¥æ“ä½œå˜æ¢æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦å¼•å…¥åç«¯çš„ååŒæ¡†æ¶ï¼Œä¾‹å¦‚`ShareDB`ç­‰ã€‚å½“ç„¶ï¼Œ`CRDT`çš„ååŒç®—æ³•ä¹Ÿæ˜¯å¯è¡Œçš„é€‰æ‹©ï¼Œè¿™å±äºåº”ç”¨çš„é€‰å‹é—®é¢˜äº†ã€‚

æ­¤å¤–ï¼Œ`OT-JSON`å¤©ç„¶å¯ä»¥æ”¯æŒæ“ä½œå†å²çš„ç»´æŠ¤ï¼Œæ¯ä¸ªæ“ä½œéƒ½æºå¸¦äº†è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿè¿½æº¯çŠ¶æ€å˜åŒ–çš„å®Œæ•´é“¾æ¡ï¼Œä¸ºæ’¤é”€/é‡åšã€ç‰ˆæœ¬å›æº¯ç­‰é«˜çº§åŠŸèƒ½æä¾›äº†åŸºç¡€ã€‚æ“ä½œä¹‹é—´çš„å› æœå…³ç³»ä¹Ÿè¢«æ˜¾å¼åœ°è®°å½•ä¸‹æ¥ï¼Œä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿåšåˆ°æ“ä½œ`A`å¿…é¡»åœ¨æ“ä½œ`B`ä¹‹å‰åº”ç”¨è¿™æ ·çš„çº¦æŸæ¡ä»¶ã€‚

æ‰©å±•æ€§è¿™éƒ¨åˆ†çš„è®¾è®¡å¯ä»¥æ˜¯æ¯”è¾ƒä¸°å¯Œçš„ï¼Œï¼Œæ ‘å½¢ç»“æ„å¤©ç„¶é€‚åˆæ‰¿è½½åµŒå¥—å¼æ•°æ®äº¤äº’ã€‚ä¾‹å¦‚é£ä¹¦æ–‡æ¡£çš„å„ç§æ¨¡å—ï¼Œéƒ½æ˜¯ä»¥`Blocks`çš„å½¢å¼æ‰©å±•å‡ºæ¥çš„ã€‚æ°å¥½é£ä¹¦çš„æ•°æ®ç»“æ„ååŒä¹Ÿæ˜¯ä½¿ç”¨`OT-JSON`æ¥å®ç°çš„ï¼Œæ–‡æœ¬çš„ååŒåˆ™æ˜¯å€ŸåŠ©äº†`EasySync`ä½œä¸º`OT-JSON`çš„å­ç±»å‹æ¥å®ç°çš„ï¼Œä»¥æ­¤æ¥æä¾›æ›´é«˜çš„æ‰©å±•æ€§ã€‚

å½“ç„¶ï¼Œæ‰©å±•æ€§å¹¶ä¸æ˜¯è¯´å¯ä»¥å®Œå…¨è‡ªç”±åœ°æ¥å…¥æ’ä»¶ï¼Œæ’ä»¶å†…çš„æ•°æ®ç»“æ„è¿˜æ˜¯éœ€è¦æ•´ä½“æ¥å—`OT-JSON`çš„è°ƒåº¦ï¼Œå¹¶ä¸”æ–‡æœ¬è¿™ç§ç‰¹æ®Šçš„å­ç±»å‹ä¹Ÿè¦å•ç‹¬è°ƒåº¦ã€‚ä»¥æ­¤ç³»ç»Ÿæ¡†æ¶èƒ½å¤Ÿå°†å„ç§å¼‚æ„å†…å®¹æ¨¡å—ç»Ÿä¸€çº³å…¥ååŒä½“ç³»ï¼Œå¹¶ä¸”å¯ä»¥å®ç°ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†ã€ååŒç¼–è¾‘ã€å†å²è®°å½•ç­‰åŠŸèƒ½ã€‚

### Immer
`Immer`ç®€åŒ–äº†ä¸å¯å˜æ•°æ®çš„æ“ä½œï¼Œå¼•å…¥ä¸€ç§ç§°ä¸ºè‰ç¨¿çŠ¶æ€çš„æ¦‚å¿µï¼Œä»¥æ­¤å…è®¸å¼€å‘è€…ä»¥ç›´è§‚çš„å¯å˜æ–¹å¼ç¼–å†™ä»£ç ï¼ŒåŒæ—¶åº•å±‚è‡ªåŠ¨ç”Ÿæˆå…¨æ–°çš„ä¸å¯å˜å¯¹è±¡ã€‚ä¼ ç»Ÿæ–¹å¼ä¸­ï¼Œä¿®æ”¹æ·±å±‚åµŒå¥—çš„æ•°æ®éœ€è¦å°å¿ƒç¿¼ç¿¼åœ°å±•å¼€æ¯ä¸€å±‚ç»“æ„ï¼Œæ—¢å®¹æ˜“å‡ºé”™åˆè®©ä»£ç æ˜¾å¾—å¤æ‚ã€‚

```js
const reducer = (state, action) => {
  return {
    ...state,
    first: {
      ...state.first,
      second: {
        ...state.first.second,
        value: action,
      },
    },
  };
};
```

è€Œ`Immer`é€šè¿‡åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„è‰ç¨¿å¯¹è±¡ï¼Œè®©å¼€å‘è€…åƒæ“ä½œæ™®é€šå¯¹è±¡ä¸€æ ·ç›´æ¥èµ‹å€¼ã€å¢åˆ å±æ€§ï¼Œç”šè‡³ä½¿ç”¨æ•°ç»„çš„`push`ã€`pop`ç­‰æ–¹æ³•ã€‚å®Œæˆæ‰€æœ‰ä¿®æ”¹åï¼Œä¾¿åŸºäºè‰ç¨¿çŠ¶æ€çš„å˜æ›´è®°å½•ï¼Œç”Ÿæˆå˜æ›´åä¸åŸå§‹æ•°æ®ç»“æ„å…±äº«æœªä¿®æ”¹éƒ¨åˆ†çš„æ–°å¯¹è±¡ã€‚è¿™ç§æœºåˆ¶æ—¢é¿å…äº†æ·±æ‹·è´çš„æ€§èƒ½æŸè€—ï¼Œåˆä¿è¯äº†æ•°æ®çš„ä¸å¯å˜æ€§ã€‚

```js
const reducer = (state, action) => {
  state.first.second.value = action;
};
```

åœ¨`Immer`ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨ä½¿ç”¨`Proxy`ä»£ç†ä¿®æ”¹è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä»…åœ¨è®¿é—®åˆ°æ•°æ®çš„æ—¶å€™æ‰ä¼šåˆ›å»º`Proxy`å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯ä¸€ç§æŒ‰éœ€ä»£ç†çš„æ‡’ä»£ç†æœºåˆ¶ï¼Œè¿™æ ·å°±ä¸éœ€è¦åˆ›å»ºè‰ç¨¿æ—¶éå†åˆ›å»ºæ‰€æœ‰ä»£ç†ã€‚è¿™ç§æœºåˆ¶æå¤§åœ°å‡å°‘äº†ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼Œå°¤å…¶å½“å¤„ç†å¤§å‹å¤æ‚å¯¹è±¡æ—¶ã€‚

ä¾‹å¦‚ä¿®æ”¹äº†ä¸€ä¸ªæ·±å±‚åµŒå¥—å±æ€§`draft.a.b.c = 1`ï¼Œ`Immer`ä¼šæ²¿ç€è®¿é—®è·¯å¾„é€å±‚ç”Ÿæˆä»£ç†ï¼Œ`Proxy(a)`ã€`Proxy(a.b)`ã€`Proxy(a.b.c)`ã€‚å› æ­¤ä½¿ç”¨`Immer`çš„æ—¶å€™è¿˜éœ€è¦æ³¨æ„ï¼Œåœ¨ä¿®æ”¹å¯¹è±¡çš„æ—¶å€™å°½å¯èƒ½ä¿æŒä»…è¯»å–éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œå…¶ä»–çš„ä»£ç†æ“ä½œè¦åœ¨è‰ç¨¿ï¼Œé¿å…ä¸å¿…è¦çš„ä»£ç†ç”Ÿæˆã€‚

### OT-JSON
åœ¨`slate`ä¸­å®ç°äº†`9`ç§åŸå­æ“ä½œæ¥æè¿°å˜æ›´ï¼Œè¿™å…¶ä¸­åŒ…å«äº†æ–‡æœ¬å¤„ç†`insert_text`ã€èŠ‚ç‚¹å¤„ç†`insert_node`ã€é€‰åŒºå˜æ¢`set_selection`çš„æ“ä½œç­‰ã€‚ä½†æ˜¯åœ¨`slate`ä¸­è™½ç„¶å®ç°äº†æ“ä½œå˜æ¢ä¸æ“ä½œåè½¬ç­‰ï¼Œä½†æ˜¯å¹¶æœªå•ç‹¬æŠ½ç¦»ç‹¬ç«‹çš„åŒ…ï¼Œå› æ­¤å¾ˆå¤šè®¾è®¡éƒ½æ˜¯å†…éƒ¨å®ç°çš„ï¼Œä¸å…·æœ‰é€šç”¨æ€§ã€‚

- `insert_node`: æ’å…¥èŠ‚ç‚¹ã€‚
- `insert_text`: æ’å…¥æ–‡æœ¬ã€‚
- `merge_node`: åˆå¹¶èŠ‚ç‚¹ã€‚
- `move_node`: ç§»åŠ¨èŠ‚ç‚¹ã€‚
- `remove_node`: ç§»é™¤èŠ‚ç‚¹ã€‚
- `remove_text`: ç§»é™¤æ–‡æœ¬ã€‚
- `set_node`: è®¾ç½®èŠ‚ç‚¹ã€‚
- `set_selection`: è®¾ç½®é€‰åŒºã€‚
- `split_node`: åˆ†å‰²èŠ‚ç‚¹ã€‚

ç±»ä¼¼çš„ï¼Œåœ¨`OT-JSON`ä¸­å®ç°äº†`11`ç§æ“ä½œï¼Œä¸”`json0`çš„ç»“æ„è®¾è®¡å·²ç»è¿‡äº†å¹¿æ³›çš„ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯é€šè¿‡ç»“æ„åŒ–çš„æ•°æ®è¡¨è¾¾ï¼Œç¡®ä¿ä¸åŒå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚æ­¤å¤–ï¼Œå¯Œæ–‡æœ¬åœºæ™¯ä¸­`SubType`ä»ç„¶éœ€è¦æ‰©å±•ï¼Œä¾‹å¦‚é£ä¹¦çš„`EasySync`ç±»å‹æ‰©å±•ï¼Œé‚£è‡ªç„¶å°±éœ€è¦æ›´å¤šçš„æ“ä½œæ¥æè¿°å˜æ›´ã€‚

- `{p:[path], na:x}`: åœ¨æŒ‡å®šçš„è·¯å¾„`[path]`å€¼ä¸ŠåŠ `x`æ•°å€¼ã€‚
- `{p:[path,idx], li:obj}`: åœ¨åˆ—è¡¨`[path]`çš„ç´¢å¼•`idx`å‰æ’å…¥å¯¹è±¡`obj`ã€‚
- `{p:[path,idx], ld:obj}`: ä»åˆ—è¡¨`[path]`çš„ç´¢å¼•`idx`ä¸­åˆ é™¤å¯¹è±¡`obj`ã€‚
- `{p:[path,idx], ld:before, li:after}`: ç”¨å¯¹è±¡`after`æ›¿æ¢åˆ—è¡¨`[path]`ä¸­ç´¢å¼•`idx`çš„å¯¹è±¡`before`ã€‚
- `{p:[path,idx1], lm:idx2}`: å°†åˆ—è¡¨`[path]`ä¸­ç´¢å¼•`idx1`çš„å¯¹è±¡ç§»åŠ¨åˆ°ç´¢å¼•`idx2`å¤„ã€‚
- `{p:[path,key], oi:obj}`: å‘è·¯å¾„`[path]`ä¸­çš„å¯¹è±¡æ·»åŠ é”®`key`å’Œå¯¹è±¡`obj`ã€‚
- `{p:[path,key], od:obj}`: ä»è·¯å¾„`[path]`ä¸­çš„å¯¹è±¡ä¸­åˆ é™¤é”®`key`å’Œå€¼`obj`ã€‚
- `{p:[path,key], od:before, oi:after}`: ç”¨å¯¹è±¡`after`æ›¿æ¢è·¯å¾„`[path]`ä¸­é”®`key`çš„å¯¹è±¡`before`ã€‚
- `{p:[path], t:subtype, o:subtypeOp}`: å¯¹è·¯å¾„`[path]`ä¸­çš„å¯¹è±¡åº”ç”¨ç±»å‹ä¸º`t`çš„å­æ“ä½œ`o`ï¼Œå­ç±»å‹æ“ä½œã€‚
- `{p:[path,offset], si:s}`: åœ¨è·¯å¾„`[path]`çš„å­—ç¬¦ä¸²çš„åç§»é‡`offset`å¤„æ’å…¥å­—ç¬¦ä¸²`s`ï¼Œå†…éƒ¨ä½¿ç”¨å­ç±»å‹ã€‚
- `{p:[path,offset], sd:s}`: ä»è·¯å¾„`[path]`çš„å­—ç¬¦ä¸²çš„åç§»é‡`offset`å¤„åˆ é™¤å­—ç¬¦ä¸²`s`ï¼Œå†…éƒ¨ä½¿ç”¨å­ç±»å‹ã€‚

é™¤äº†åŸå­åŒ–çš„æ“ä½œä¹‹å¤–ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯æ“ä½œå˜æ¢çš„ç®—æ³•å®ç°ï¼Œè¿™éƒ¨åˆ†æ˜¯ååŒçš„åŸºç¡€ã€‚`JSON`çš„åŸå­æ“ä½œå¹¶éå®Œå…¨ç‹¬ç«‹çš„ï¼Œå¿…é¡»è¦é€šè¿‡æ“ä½œå˜æ¢æ¥ä¿è¯æ“ä½œçš„æ‰§è¡Œé¡ºåºå¯ä»¥éµå¾ªå…¶å› æœä¾èµ–ã€‚åŒæ—¶ï¼Œå¯¹äºæ“ä½œåè½¬çš„å®ç°ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œè¿™éƒ¨åˆ†æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å®ç°æ’¤é”€ã€é‡åšç­‰åŠŸèƒ½ã€‚

## æ•°æ®ç»“æ„
åœ¨ä½ä»£ç ã€å¯Œæ–‡æœ¬ã€ç”»æ¿/ç™½æ¿ã€è¡¨å•å¼•æ“ç­‰ç­‰ç¼–è¾‘å™¨åº”ç”¨åœºæ™¯ä¸­ï¼Œä»…ä»…æ˜¯ä½¿ç”¨`JSON`æ•°æ®ç»“æ„æ¥æè¿°å†…å®¹æ˜¯ä¸å¤Ÿçš„ã€‚ç±»æ¯”åœ¨ç»„ä»¶ä¸­ï¼Œ`div`æ˜¯æè¿°è§†å›¾çš„ï¼ŒçŠ¶æ€æ˜¯éœ€è¦é¢å¤–å®šä¹‰çš„ï¼Œå¹¶ä¸”é€šè¿‡äº‹ä»¶é©±åŠ¨æ¥æ”¹å˜çŠ¶æ€ã€‚è€Œåœ¨ç¼–è¾‘å™¨åœºæ™¯ä¸­ï¼Œ`JSON`æ—¢æ˜¯è§†å›¾æè¿°ä¹Ÿæ˜¯è¦æ“ä½œçš„çŠ¶æ€ã€‚

é‚£ä¹ˆåŸºäº`JSON`æ¥æ¸²æŸ“è§†å›¾è¿™ä»¶äº‹å¹¶ä¸å¤æ‚ï¼Œç‰¹åˆ«æ˜¯åœ¨è¡¨æ ¼æ¸²æŸ“ä¸­çš„åœºæ™¯ä¼šå¾ˆå¸¸è§ã€‚è€Œé€šè¿‡æ“ä½œæ¥å˜æ›´æ•°æ®ç»“æ„åˆ™å¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œé‚£ä¹ˆåŸºäº`OT-JSON`æˆ‘ä»¬å¯ä»¥å®ç°åŸå­åŒ–çš„æ•°æ®å˜æ›´ï¼Œä¸`Immer`ç»“åˆåˆ™å¯ä»¥é…åˆè§†å›¾çš„æ¸²æŸ“åˆ·æ–°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å…ˆä»¥å•å…ƒæµ‹è¯•çš„æ–¹å¼æµ‹è¯•æ•°æ®ç»“æ„çš„æ“ä½œå˜æ¢ã€‚

### åŸºæœ¬æ“ä½œ
é’ˆå¯¹æ•°æ®çš„åŸºæœ¬æ“ä½œï¼Œæ— éå°±æ˜¯å¢åˆ æ”¹æŸ¥ï¼ŒæŸ¥è¿™éƒ¨åˆ†ä¸»è¦å°±æ˜¯æ ¹æ®`path`è¯»æ•°æ®å³å¯ï¼Œè€Œæˆ‘ä»¬å…³æ³¨çš„ä¸»è¦æ˜¯å¢åˆ æ”¹è¿™éƒ¨åˆ†ä¸`Immer`çš„ç»“åˆã€‚é¦–å…ˆæ˜¯`insert`æ“ä½œï¼Œ`p`è¡¨ç¤ºè·¯å¾„ï¼Œ`li`è¡¨ç¤ºæ’å…¥å€¼ï¼Œåœ¨å˜æ›´ä¹‹åå°±å¯ä»¥æ£€æŸ¥å˜æ›´åçš„å€¼æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæœªä¿®æ”¹å¯¹è±¡çš„å¼•ç”¨å¤ç”¨ã€‚

```js
// packages/immer-ot-json/test/insert.test.ts
const baseState = {
  a: {
    b: [1] as number[],
  },
  d: { e: 2 },
};
const draft = createDraft(baseState);
const op: Op = {
  p: ["a", "b", 0],
  li: 0,
};
json.type.apply(draft, [op]);
const nextState = finishDraft(draft);
expect(nextState.a.b[0]).toBe(0);
expect(nextState.a.b[1]).toBe(1);
expect(nextState.a).not.toBe(baseState.a);
expect(nextState.a.b).not.toBe(baseState.a.b);
expect(nextState.d).toBe(baseState.d);
expect(nextState.d.e).toBe(baseState.d.e);
```

åˆ é™¤æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„å®ç°ï¼Œ`ld`è¡¨ç¤ºåˆ é™¤å€¼ï¼Œæ³¨æ„è¿™é‡Œæ˜¯åˆ é™¤çš„å…·ä½“å€¼è€Œä¸æ˜¯ç´¢å¼•ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†`invert`è½¬æ¢çš„æ–¹ä¾¿ã€‚åŒæ ·å¯ä»¥çœ‹åˆ°ï¼Œ`Immer`çš„`draft`å¯¹è±¡åœ¨å˜æ›´ä¹‹åï¼Œåªæœ‰å˜æ›´çš„éƒ¨åˆ†æ˜¯æ–°çš„å¯¹è±¡ï¼Œå…¶ä»–éƒ¨åˆ†æ˜¯å¼•ç”¨å¤ç”¨çš„ã€‚

```js
// packages/immer-ot-json/test/delete.test.ts
const baseState = {
  a: {
    b: [0, 1, 2] as number[],
  },
  d: { e: 2 },
};
const draft = createDraft(baseState);
const op: Op = {
  p: ["a", "b", 1],
  ld: 1,
};
json.type.apply(draft, [op]);
const nextState = finishDraft(draft);
expect(nextState.a.b[0]).toBe(0);
expect(nextState.a.b[1]).toBe(2);
expect(nextState.a).not.toBe(baseState.a);
expect(nextState.a.b).not.toBe(baseState.a.b);
expect(nextState.d).toBe(baseState.d);
expect(nextState.d.e).toBe(baseState.d.e);
```

æ›´æ–°æ“ä½œåœ¨`OT-JSON`ä¸­å®é™…ä¸Šéœ€è¦åŒæ—¶å®šä¹‰`oi`å’Œ`od`ï¼Œç›¸å½“äºä¸¤ä¸ªåŸå­æ“ä½œçš„ç»„åˆï¼Œå…·ä½“çš„å®ç°æ˜¯å…ˆæ’å…¥ååˆ é™¤ã€‚åŒæ ·çš„ï¼Œå°†ä¸¤è€…çš„å€¼éƒ½æ”¾ç½®å‡ºæ¥è€Œä¸æ˜¯ä»…å¤„ç†ç´¢å¼•ï¼Œåœ¨`invert`æ—¶å°±ä¸éœ€è¦`snapshot`æ¥è¾…åŠ©å¾—åˆ°åŸå§‹å€¼ï¼Œå¹¶ä¸”`Immer`çš„å¤ç”¨æ•ˆæœä»ç„¶æ²¡æœ‰é—®é¢˜ã€‚

```js
// packages/immer-ot-json/test/update.test.ts
const baseState = {
  a: {
    b: { c: 1 },
  },
  d: { e: 2 },
};
const draft = createDraft(baseState);
const op: Op = {
  p: ["a", "b", "c"],
  // åº”ç”¨æ—¶æœªæ ¡éªŒ, ä½†ä¸ºäº†ä¿è¯ invert çš„æ­£ç¡®æ€§, è¿™é‡Œéœ€è¦ç¡®å®šåŸå§‹å€¼
  // https://github.com/ottypes/json0/blob/master/lib/json0.js#L237
  od: 1,
  oi: 3,
};
json.type.apply(draft, [op]);
const nextState = finishDraft(draft);
expect(nextState.a.b.c).toBe(3);
expect(nextState.a).not.toBe(baseState.a);
expect(nextState.a.b).not.toBe(baseState.a.b);
expect(nextState.d).toBe(baseState.d);
expect(nextState.d.e).toBe(baseState.d.e);
```

### æ“ä½œå˜æ¢
æ“ä½œå˜æ¢çš„åº”ç”¨åœºæ™¯ä¸»è¦æ˜¯åœ¨ååŒç¼–è¾‘ä¸­ï¼Œä½†æ˜¯åœ¨éååŒçš„æƒ…å†µä¸‹ä¹Ÿæœ‰ç€å¤§é‡åº”ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸Šä¼ å›¾ç‰‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å°†ä¸Šä¼ ä¸­çš„è¿™ä¸ªçŠ¶æ€æ”¾ç½®åœ¨`undo`æ ˆä¸­ï¼Œè€Œæ— è®ºæ˜¯å°†å…¶ä½œä¸ºä¸å¯æ’¤é”€çš„æ“ä½œï¼Œè¿˜æ˜¯åˆå¹¶å…ˆå‰`undo`æ ˆä¸­å·²æœ‰çš„æ“ä½œï¼Œéƒ½éœ€è¦æ“ä½œå˜æ¢çš„å®ç°ã€‚

æˆ‘ä»¬å¯ä»¥ç†è§£`b'=transform(a, b)`çš„æ„æ€æ˜¯ï¼Œå‡è®¾`a`å’Œ`b`éƒ½æ˜¯ä»ç›¸åŒçš„`draft`åˆ†æ”¯å‡ºæ¥çš„ï¼Œé‚£ä¹ˆ`b'`å°±æ˜¯å‡è®¾`a`å·²ç»åº”ç”¨äº†ï¼Œæ­¤æ—¶`b`éœ€è¦åœ¨`a`çš„åŸºç¡€ä¸Šå˜æ¢å‡º`b'`æ‰èƒ½ç›´æ¥åº”ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£ä¸º`transform`è§£å†³äº†`a`æ“ä½œå¯¹`b`æ“ä½œé€ æˆçš„å½±å“ï¼Œå³ç»´æŠ¤å› æœå…³ç³»ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬ä»ç„¶æµ‹è¯•æœ€åŸºæœ¬çš„`insert`ã€`delete`ã€`retain`çš„æ“ä½œå˜æ¢ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå› æœå…³ç³»ä¸­ä½ç½®çš„åç§»æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œä¾‹å¦‚è¿œç¨‹çš„`b`æ“ä½œä¸å³å°†åº”ç”¨çš„`a`æ“ä½œéƒ½æ˜¯åˆ é™¤æ“ä½œï¼Œå½“`b`æ“ä½œæ‰§è¡Œæ—¶`a`æ“ä½œè¦åˆ é™¤çš„å†…å®¹éœ€è¦åœ¨`b`çš„æ“ä½œç»“æœåé‡æ–°è®¡ç®—ç´¢å¼•ã€‚

```js
// packages/immer-ot-json/test/transform.test.ts
// insert
const base: Op[] = [{ p: [1] }];
const op: Op[] = [{ p: [0], li: 1 }];
const tf = type.transform(base, op, "left");
expect(tf).toEqual([{ p: [2] }]);

// delete
const base: Op[] = [{ p: [1] }];
const op: Op[] = [{ p: [0], ld: 1 }];
const tf = type.transform(base, op, "left");
expect(tf).toEqual([{ p: [0] }]);

// retain
const base: Op[] = [{ p: [1] }];
const op: Op[] = [{ p: [1, "key"], oi: "value" }];
const tf = type.transform(base, op, "left");
expect(tf).toEqual([{ p: [1] }]);
```

### åè½¬æ“ä½œ
åè½¬æ“ä½œå³`invert`æ–¹æ³•ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°`undo`ã€`redo`ç­‰åŠŸèƒ½ã€‚å‰è¾¹æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œè¿›è¡Œ`apply`çš„æ—¶å€™å¾ˆå¤šæ“ä½œæ˜¯éœ€è¦æ‹¿åˆ°åŸå§‹å€¼çš„ï¼Œè¿™äº›å€¼åœ¨æ‰§è¡Œæ—¶å¹¶æœªå®é™…æ ¡éªŒï¼Œä½†æ˜¯è¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨`invert`æ—¶ç›´æ¥è½¬æ¢ï¼Œä¸éœ€è¦`snapshot`æ¥è¾…åŠ©è®¡ç®—å€¼ã€‚

æ­¤å¤–ï¼Œ`invert`æ”¯æŒçš„æ˜¯æ‰¹é‡çš„æ“ä½œåè½¬ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥æ”¶çš„å‚æ•°æ˜¯`Op[]`ã€‚è¿™é‡Œå¯ä»¥ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œåº”ç”¨æ—¶æ•°æ®æ“ä½œæ­£å‘çš„ï¼Œè€Œåè½¬æ—¶çš„æ‰§è¡Œé¡ºåºæ˜¯éœ€è¦åè½¬çš„ï¼Œä¾‹å¦‚`abc`çš„ä¸‰ä¸ªæ“ä½œï¼Œåœ¨`invert`åå¯¹åº”çš„åº”è¯¥æ˜¯`cba`çš„åè½¬`op`ã€‚

```js
// packages/immer-ot-json/test/invert.test.ts
// insert
const op: Op[] = [{ p: [0], li: 1 }];
const inverted = type.invert(op);
expect(inverted).toEqual([{ p: [0], ld: 1 }]);

// delete
const op: Op[] = [{ p: [0], ld: 1 }];
const inverted = type.invert(op);
expect(inverted).toEqual([{ p: [0], li: 1 }]);

// retain
const op: Op[] = [{ p: [1, "key"], oi: "value2", od: "value1" }];
const inverted = type.invert(op);
expect(inverted).toEqual([{ p: [1, "key"], od: "value2", oi: "value1" }]);
```

### æ‰¹é‡åº”ç”¨
æ‰¹é‡åº”ç”¨æ“ä½œæ˜¯ä¸ªéå¸¸éº»çƒ¦çš„é—®é¢˜ï¼Œ`OT-JSON`æ˜¯æ”¯æŒå¤šä¸ª`op`åŒæ—¶åº”ç”¨çš„ï¼Œç„¶è€Œåœ¨`apply`æ—¶æ•°æ®æ˜¯å•ä¸ªæ“ä½œæ‰§è¡Œçš„ã€‚è¿™ä¸ªåœºæ™¯è¿˜æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¾‹å¦‚åœ¨å®ç°ç”»æ¿æ—¶ï¼ŒæŒ‰ä½`shift`å¹¶ä¸”å•å‡»å›¾å½¢èŠ‚ç‚¹å¯ä»¥å¤šé€‰ï¼Œç„¶åæ‰§è¡Œåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªåŒæ—¶åŸºäº`draft`çš„æ‰¹é‡æ“ä½œï¼Œç†è®ºä¸Šä¼šå­˜åœ¨å› æœå…³ç³»ã€‚

åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç°åœ¨æœ‰`4`ä¸ª`op`ï¼Œå¹¶ä¸”å­˜åœ¨é‡å¤çš„ç´¢å¼•å€¼å¤„ç†ã€‚é‚£ä¹ˆåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç†è®ºä¸ŠæœŸå¾…çš„ç»“æœåº”è¯¥æ˜¯å°†`1/2/3`çš„å€¼åˆ é™¤æ‰ï¼Œå³æœ€ç»ˆç»“æœæ˜¯`[0, 4, 5, 6]`ï¼Œç„¶è€Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœå´æ˜¯`[0, 2, 4]`ï¼Œè¿™å°±æ˜¯`apply`æ˜¯ç‹¬ç«‹æ‰§è¡Œï¼Œä¸”æ²¡æœ‰å¤„ç†`op`é—´çš„å…³è”æ€§å¼•èµ·çš„ã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const baseState = {
  a: {
    b: [0, 1, 2, 3, 4, 5, 6] as number[],
  },
};
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 3], ld: 3 },
];
const nextState = type.apply(baseState, ops);
expect(nextState.a.b).toEqual([0, 2, 4]);
```

é‚£ä¹ˆç”±äºå…ˆå‰æåˆ°è¿‡äº†ï¼Œ`transform`è§£å†³äº†`a`æ“ä½œå¯¹`b`æ“ä½œé€ æˆçš„å½±å“ï¼Œå³ç»´æŠ¤å› æœå…³ç³»ã€‚é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡`transform`æ¥å¤„ç†æ“ä½œä¹‹é—´çš„å…³è”æ€§é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°è¯•è°ƒç”¨`transform`æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

ç„¶è€Œ`transform`çš„å‡½æ•°ç­¾åæ˜¯`transform(op1, op2, side)`ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸¤ç»„æ“ä½œä¹‹é—´è¿›è¡Œå˜æ¢ï¼Œç„¶è€Œæˆ‘ä»¬ç°åœ¨çš„`ops`æ˜¯ä»…å•ç»„æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿™éƒ¨åˆ†åº”è¯¥å¦‚ä½•ç»“åˆã€‚å¦‚æœä»¥ç©ºç»„å˜æ¢`ops`ç»„çš„è¯ï¼Œè¿”å›çš„ç»“æœæ˜¯`[]`æ˜¯ä¸æ­£ç¡®çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°è¯•å•`op`æ¥å¤„ç†ã€‚

å› æ­¤ï¼Œæœ€å¼€å§‹æˆ‘å‡†å¤‡è€ƒè™‘ä½¿ç”¨å°†å·²ç»åº”ç”¨è¿‡çš„`ops`æ“ä½œè£å‰ªå‡ºæ¥ï¼Œç„¶åå°†å…¶ç›´æ¥å½±å“çš„å€¼é€šè¿‡`transform`æ¥ç§»é™¤ï¼Œè¿™é‡Œè¿˜éœ€è¦è€ƒè™‘æ˜¯å¦éœ€è¦å°†åº”ç”¨è¿‡çš„æ“ä½œé¡ºåºåè½¬å†å˜æ¢ï¼Œè€Œä¸”è¿™é‡Œä¹Ÿèƒ½å¤Ÿçœ‹åˆ°åˆ é™¤çš„å€¼æ²¡æœ‰é—®é¢˜ï¼Œä¸”é‡å¤çš„æ“ä½œä¹Ÿèƒ½å¤Ÿæ­£ç¡®å¤„ç†ã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const baseState = {
  a: {
    b: [0, 1, 2, 3, 4, 5, 6] as number[],
  },
};
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 3], ld: 3 },
];
const tfOps = ops.map((op, index) => {
  const appliedOps = ops.slice(0, index);
  appliedOps.reverse();
  const nextOps = type.transform([op], appliedOps, "left");
  return nextOps[0];
});
expect(tfOps[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(tfOps[1]).toEqual({ p: ["a", "b", 1], ld: 2 });
expect(tfOps[2]).toEqual({ p: ["a", "b", 1], ld: 3 });
expect(tfOps[3]).toEqual(undefined);
const nextState = type.apply(baseState, tfOps.filter(Boolean));
expect(nextState.a.b).toEqual([0, 4, 5, 6]);
```

åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†å…¶ç®€å•å°è£…ä¸€ä¸‹ï¼Œç„¶åç›´æ¥è°ƒç”¨å‡½æ•°å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ç»“æœï¼Œè¿™æ ·å°±ä¸éœ€è¦å°†é€»è¾‘å…¨éƒ¨æ··æ‚åœ¨æ•´ä¸ªåº”ç”¨çš„è¿‡ç¨‹ä¸­ã€‚è¿™é‡Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹`Delta`çš„`OT`å®ç°ï¼Œå•æ¬¡`Delta`çš„`ops`æ˜¯ä»¥ç›¸å¯¹ä½ç½®å¤„ç†çš„æ•°æ®ï¼Œè€Œ`OT-JSON`æ˜¯ç»å¯¹ä½ç½®ï¼Œå› æ­¤åœ¨æ‰¹é‡å¤„ç†æ—¶éœ€è¦è¿›è¡Œè½¬æ¢ã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 3], ld: 3 },
];
const transformLocal = (op1: Op, base: Op[], dir: "left" | "right"): Op => {
  let transformedOp = op1;
  const reversed = [...base].reverse();
  for (const op of reversed) {
    const [result] = type.transformComponent([], transformedOp, op, dir);
    if (!result) return result;
    transformedOp = result;
  }
  return transformedOp;
};
ops.forEach((op, index) => {
  const appliedOps = ops.slice(0, index);
  const a1 = transformLocal(op, appliedOps, "left");
  appliedOps.reverse();
  const b1 = type.transform([op], appliedOps, "left");
  expect(a1).toEqual(b1[0]);
});
```

ç„¶è€Œçœ‹èµ·æ¥ä¸Šè¿°çš„ä¾‹å­è¡¨ç°æ˜¯æ²¡é—®é¢˜çš„ï¼Œç„¶è€Œè€ƒè™‘åˆ°å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹æ‰§è¡Œé¡ºåºçš„é—®é¢˜ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶ä»…ä»…æ˜¯è°ƒæ•´äº†`ops`çš„é¡ºåºï¼Œä½†æœ€ç»ˆå´å¾—åˆ°äº†é”™è¯¯çš„ç»“æœã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
];
const tfOps = ops.map((op, index) => {
  const appliedOps = ops.slice(0, index);
  appliedOps.reverse();
  const nextOps = type.transform([op], appliedOps, "left");
  return nextOps[0];
});
expect(tfOps[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(tfOps[1]).toEqual({ p: ["a", "b", 2], ld: 3 });
expect(tfOps[2]).toEqual({ p: ["a", "b", 1], ld: 2 });
// è¿™é‡Œæ˜¯å­˜åœ¨é—®é¢˜çš„ å¸Œæœ›å¾—åˆ°çš„ç»“æœæ˜¯ undefined
expect(tfOps[3]).toEqual({ p: ["a", "b", 1], ld: 3 });
```

æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ç©¶ç«Ÿåº”è¯¥å¦‚ä½•æ‹æ¸…æ¥šè¿™ä¸ªå› æœå…³ç³»é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘åˆ°è¿™ä»¶äº‹æœ¬èº«å°±åº”è¯¥æ˜¯ç”±`a`åº”ç”¨åï¼Œ`b`å‘ç”Ÿäº†å˜æ›´ã€‚é‚£ä¹ˆåœ¨`abcd`è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯ä»¥`a`ä¸ºåŸºå‡†ï¼Œå˜æ¢`b/c/d`ï¼Œç„¶åä»¥`b`ä¸ºåŸºå‡†ï¼Œå˜æ¢`c/d`ï¼Œä»¥æ­¤ç±»æ¨ã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
];
const copied: Op[] = [...ops];
const len = copied.length;
for (let i = 0; i < len; i++) {
  // è¿™é‡Œæ˜¯ copied è€Œä¸æ˜¯ ops, æ˜¯åº”ç”¨åçš„æ“ä½œ
  // å¦åˆ™ä¼šå¯¼è‡´å®é™…è½®è½¬çš„æ“ä½œå˜æ¢äº§ç”Ÿé”™è¯¯
  // ä¾‹å¦‚ [1,2,3] ä¸‹ä¼šå‡ºç° [1,1,undefined] çš„æƒ…å†µ
  const base = copied[i];
  for (let k = i + 1; k < len; k++) {
    const op = copied[k];
    if (!op) continue;
    const nextOp = type.transformComponent([], op, base, "left");
    copied[k] = nextOp[0];
  }
}
expect(copied[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(copied[1]).toEqual({ p: ["a", "b", 2], ld: 3 });
expect(copied[2]).toEqual({ p: ["a", "b", 1], ld: 2 });
expect(copied[3]).toEqual(undefined);
```

è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨å®é™…ä¸Šæ˜¯å¤šä¸ª`op`ç»„åˆçš„æ—¶å€™ï¼Œå…¶æ¯ä¸ªæ“ä½œéƒ½æ˜¯ç‹¬ç«‹çš„ç»å¯¹ä½ç½®ï¼Œå¹¶éä¼šå°†å…¶å®ç°ä¸ºç›¸å¯¹çš„ä½ç½®ï¼Œä¾‹å¦‚åœ¨`Delta`ä¸­ï¼Œ`compose`æ“ä½œæ˜¯ä¼šè®¡ç®—ä¸ºç›¸å¯¹ä½ç½®çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶ä¹Ÿå¯ä»¥å°†å…¶å°è£…ä¸º`composeWith`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨åˆå¹¶`ops`æ—¶ï¼Œä¾‹å¦‚å†å²æ“ä½œçš„åˆå¹¶ä¼šéå¸¸æœ‰ç”¨ã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
];
const composeWith = (base: Op[], ops: Op[]) => {
  const waiting: Op[] = [];
  for (const opa of ops) {
    let nextOp = opa;
    for (const opb of base) {
      nextOp = type.transformComponent([], nextOp, opb, "left")[0];
      if (!nextOp) break;
    }
    nextOp && waiting.push(nextOp);
  }
  return base.concat(waiting.filter(Boolean));
};
const copied = ops.reduce((acc, op) => composeWith(acc, [op]), [] as Op[]);
expect(copied[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(copied[1]).toEqual({ p: ["a", "b", 2], ld: 3 });
expect(copied[2]).toEqual({ p: ["a", "b", 1], ld: 2 });
expect(copied[3]).toEqual(undefined);
```

æœ€åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘åˆ°ä¸€ä¸ªè·¯å¾„æŒæœ‰çš„åœºæ™¯ï¼Œç±»ä¼¼äºæˆ‘ä»¬å®ç°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„`Ref`æ¨¡å—ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“ä¸Šä¼ å›¾ç‰‡æ—¶ï¼Œ`loading`çŠ¶æ€æ—¶å¯èƒ½ä¼šæœ‰ç”¨æˆ·æ“ä½œæ”¹å˜äº†åŸå§‹è·¯å¾„ï¼Œè¿™ä¸ªæƒ…å†µä¸‹å½“ä¸Šä¼ ç»“æŸåå°†å®é™…åœ°å€å†™å…¥èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦æ‹¿åˆ°æœ€æ–°çš„`path`ã€‚

```js
// packages/immer-ot-json/test/batch.test.ts
const baseState = {
  a: {
    b: [0, 1, 2, 3, 4, 5, 6] as number[],
  },
};
// æŒæœ‰ä¸”å˜æ¢åçš„æ“ä½œ ç›®çš„æ˜¯å˜æ¢ path
// ä¾‹å¦‚å¦‚æœæ˜¯ ld çš„è¯ åˆ™åº”è¯¥å…ˆå˜æ¢ [5,6] => [5,5]
const refOps: Op[] = [
  { p: ["a", "b", 5, "attrs"], od: "k", oi: "v" },
  { p: ["a", "b", 6, "attrs"], od: "k1", oi: "v1" },
];
const apply = (snapshot: typeof baseState, ops: Op[]) => {
  for (let i = 0, n = ops.length; i < n; ++i) {
    const tfOp = ops[i];
    if (!tfOp) continue;
    // å˜æ¢å‡ºå¯ç›´æ¥åº”ç”¨çš„ ops å, ref module å¯ä»¥æŒæœ‰æŒ‰åºå˜æ¢
    for (let k = 0, n = refOps.length; k < n; ++k) {
      const refOp = refOps[k];
      if (!refOp) continue;
      const [result] = type.transformComponent([], refOp, tfOp, "left");
      refOps[k] = result;
    }
  }
  return type.apply(snapshot, ops);
};
const tfOps: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 3 },
  { p: ["a", "b", 1], ld: 2 },
];
const nextState = apply(baseState, tfOps);
expect(nextState.a.b).toEqual([0, 4, 5, 6]);
expect(refOps[0]).toEqual({ p: ["a", "b", 2, "attrs"], od: "k", oi: "v" });
expect(refOps[1]).toEqual({ p: ["a", "b", 3, "attrs"], od: "k1", oi: "v1" });
```

## ä½ä»£ç åœºæ™¯
åœ¨è¿™é‡Œæˆ‘ä»¬ä»¥ç®€å•çš„åˆ—è¡¨åœºæ™¯ä¸ºç¤ºä¾‹ï¼ŒåŸºäº`Immer`ä»¥åŠ`OT-JSON`å®ç°åŸºæœ¬çš„çŠ¶æ€ç®¡ç†ã€‚åˆ—è¡¨çš„åœºæ™¯ä¼šæ˜¯æ¯”è¾ƒé€šç”¨çš„å®ç°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¼šå®ç°åˆ—è¡¨çš„å¢åˆ ã€é€‰åŒºå¤„ç†ã€å†å²æ“ä½œç­‰åŠŸèƒ½ï¼Œè¿™å…¶ä¸­å¾ˆå¤šè®¾è®¡æ˜¯å‚è€ƒ`slate`çš„çŠ¶æ€ç®¡ç†å®ç°ã€‚


### æ•°æ®æ“ä½œ
`OT-JSON`è¿›è¡Œ`apply`çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„æ–¹æ¡ˆæ˜¯é€ä¸ªæ‰§è¡Œ`op`ã€‚é‚£ä¹ˆä½¿ç”¨`OT-JSON`æ¥ç®¡ç†çŠ¶æ€çš„æ—¶å€™ï¼Œä¼šå¾ˆå®¹æ˜“æ€è€ƒå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ›´æ”¹äº†æ¯”è¾ƒå†…éƒ¨çš„æ•°æ®çŠ¶æ€ï¼Œ`provider`æä¾›çš„`value`åœ¨æœ€é¡¶å±‚çš„å¯¹è±¡å¼•ç”¨å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå¯èƒ½ä¸ä¼šå¼•èµ·`render`ã€‚

ä¸ºä»€ä¹ˆè¯´å¯èƒ½ä¸å¼•èµ·`render`ï¼Œå¦‚æœæˆ‘ä»¬åœ¨çŠ¶æ€å˜æ›´ä¹‹åï¼Œç›´æ¥å¼•ç”¨çš„å¯¹è±¡ä¸å‘ç”Ÿæ”¹å˜ï¼Œ`setState`ä¸ä¼šå¼•èµ·æ¸²æŸ“è¡Œä¸ºã€‚ä½†æ˜¯å¦‚æœç»„ä»¶çŠ¶æ€è¾ƒå¤šï¼Œå…¶ä»–çš„çŠ¶æ€å˜æ›´ä»ç„¶ä¼šå¼•èµ·æ•´ä¸ªç»„ä»¶çš„çŠ¶æ€åˆ·æ–°ï¼Œä¾‹å¦‚ä¸‹é¢çš„`Child`ç»„ä»¶æœ¬èº«æ²¡æœ‰`props`å‘ç”Ÿæ”¹å˜ï¼Œä½†`count`å€¼çš„å˜åŒ–è¿˜æ˜¯ä¼šå¯¼è‡´å‡½æ•°ç»„ä»¶æ‰§è¡Œã€‚

```js
// https://reactplayground.vercel.app/
import React, { useState, Fragment } from 'react';

const Child = () => {
  console.log("render child");
  return <div>Child</div>;
}

const App = () => {
  const [count, setCount] = useState(0)
  const handleClick = () => {
    setCount(c => c + 1);
  }
  return (
    <Fragment>
      <button onClick={handleClick}>{count}</button>
      <Child></Child>
    </Fragment>
  );
}

export default App;
```

å½“ç„¶æˆ‘ä»¬åœ¨ä¸è€ƒè™‘å…¶ä»–çŠ¶æ€å˜æ›´çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶æœ€é¡¶å±‚çš„å¯¹è±¡å¼•ç”¨ä¸å˜ï¼Œé‚£ä¹ˆè‡ªç„¶æ•´ä¸ªè§†å›¾éƒ½ä¸ä¼šåˆ·æ–°ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è¦ä»å˜æ›´çš„èŠ‚ç‚¹å¼€å§‹ï¼Œä»¥æ­¤å‘ä¸Šçš„èŠ‚ç‚¹éƒ½éœ€è¦å˜æ›´å¼•ç”¨å€¼ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè‹¥`C`å‘ç”Ÿæ”¹å˜ï¼Œåˆ™`A`ã€`C`çš„å¼•ç”¨éœ€è¦å˜æ›´ï¼Œå…¶ä»–å¯¹è±¡ä¿æŒåŸå§‹å€¼ï¼Œ`Immer`æ°å¥½èƒ½å¤Ÿå¸®æˆ‘ä»¬å®ç°è¿™ä¸ªèƒ½åŠ›ã€‚

```
   A
  / \
 B   C
    / \
   D   E
```

å½“ç„¶ï¼Œåœ¨å…ˆå‰çš„ä¾‹å­ä¸­ä¹Ÿå¯ä»¥å‘ç°ï¼Œå³ä½¿`props`çš„å€¼ä¸å˜ï¼Œåœ¨æœ€é¡¶å±‚çš„å€¼å˜æ›´ä¹‹åè¿˜æ˜¯ä¼šå¯¼è‡´æ•´ä¸ªå‡½æ•°ç»„ä»¶é‡æ–°æ‰§è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯éœ€è¦é…åˆ`React.memo`ä½¿ç”¨ï¼Œä»¥æ­¤æ¥æ§åˆ¶å‡½æ•°ç»„ä»¶æ˜¯å¦éœ€è¦é‡æ–°æ‰§è¡Œï¼Œå°†ä¸Šé¢ä¾‹å­ä¸­çš„`Child`ç»„ä»¶åŒ…è£…`memo`ï¼Œå°±å¯ä»¥é¿å…åœ¨`count`å€¼å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œç»„ä»¶ã€‚

```js
const Child = React.memo(() => {
  console.log("render child");
  return <div>Child</div>;
})
```

### è·¯å¾„æŸ¥æ‰¾
é€šå¸¸æ¥è¯´ï¼Œåœ¨æ‰§è¡Œå˜æ›´æ—¶æˆ‘ä»¬éœ€è¦å¾—åˆ°è¦å¤„ç†çš„ç›®æ ‡`path`ï¼Œç‰¹åˆ«æ˜¯æ¸²æŸ“åç»„ä»¶è¦æ“ä½œæœ¬èº«æ—¶ã€‚åœ¨æ™®é€šçš„å˜æ›´ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½æ›´å¤šçš„æ˜¯ä¾èµ–é€‰åŒºèŠ‚ç‚¹çš„è¡¨è¾¾ï¼Œæ¥å¾—åˆ°è¦å¤„ç†çš„ç›®æ ‡èŠ‚ç‚¹ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æƒ³å®ç°æ¯”è¾ƒå¤æ‚çš„æ¨¡å—æˆ–è€…äº¤äº’æ—¶ï¼Œä¾‹å¦‚å›¾ç‰‡çš„å¼‚æ­¥ä¸Šä¼ ç­‰åœºæ™¯æ—¶ï¼Œè¿™å¯èƒ½å¹¶ä¸è¶³ä»¥è®©æˆ‘ä»¬å®Œæˆè¿™äº›åŠŸèƒ½ã€‚

å½“æˆ‘ä»¬ä½¿ç”¨`React.memo`æ¥æ§åˆ¶ç»„ä»¶æ¸²æŸ“åï¼Œå…¶å®ä¼šéšå¼åœ°å¼•å…¥ä¸€ä¸ªé—®é¢˜ã€‚ä¾‹å¦‚æ­¤æ—¶æˆ‘ä»¬æœ‰äºŒçº§åˆ—è¡¨åµŒå¥—ï¼Œä»¥åŠå†…å®¹èŠ‚ç‚¹`[1,2]`ï¼Œå¦‚æœåœ¨`[1]`è¿™ä¸ªä½ç½®ä¸Šæ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç†è®ºä¸ŠåŸå§‹çš„å€¼åº”è¯¥å˜ä¸º`[2,2]`ï¼Œç„¶è€Œç”±äºå‡½æ•°ç»„ä»¶å¹¶æœªæ‰§è¡Œï¼Œå…¶ä¾ç„¶ä¼šä¿æŒåŸå§‹çš„`[1,2]`ã€‚

```js
[
  [0,   0,   0]
  [1,   1,   1(*)]   
]
// insert [1] [0,0,0] =>
[
  [0,   0,   0]
  [0,   0,   0]
  [1,   1,   1(*)]   
]
```

è¿™é‡Œä¿æŒåŸå§‹çš„`[1,2]`å…·ä½“æŒ‡çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°†`path`åœ¨æ¸²æŸ“æ—¶ä¼ é€’ç»™`props`ï¼Œå¹¶ä¸”è‡ªå®šä¹‰`memo`çš„`equal`å‡½æ•°å¹¶ä¸”ä¼ é€’`path`ï¼Œé‚£ä¹ˆä½ç´¢å¼•å€¼çš„å˜æ›´ä¼šå¯¼è‡´å¤§é‡èŠ‚ç‚¹çš„ç»„ä»¶é‡æ–°æ‰§è¡Œï¼Œæ€§èƒ½ä¼šé‡æ–°åŠ£åŒ–ã€‚è€Œå¦‚æœä¸ä¼ é€’ç»™`props`çš„è¯ï¼Œåœ¨ç»„ä»¶å†…éƒ¨è‡ªç„¶æ— æ³•æ‹¿åˆ°èŠ‚ç‚¹æ¸²æŸ“çš„`path`ã€‚

åœ¨æˆ‘ä»¬å®ç°æ’ä»¶åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªæ’ä»¶æ¥å®ç°å¤šä¸ªç»„ä»¶çš„æ¸²æŸ“ï¼Œè¿™äº›ç»„ä»¶éƒ½æ˜¯åŒä¸€ç§ç±»å‹ï¼Œå´æ˜¯æ¸²æŸ“åœ¨ä¸åŒ`path`ä¸‹çš„ã€‚å› æ­¤é€šè¿‡æ’ä»¶æ¥è·å–ç”±è¯¥æ’ä»¶æ¸²æŸ“å‡ºç»„ä»¶çš„`path`è¿˜æ˜¯éœ€è¦é€šè¿‡å¤–å±‚æ¸²æŸ“çŠ¶æ€æ¥ä¼ é€’ï¼Œä¸Šè¿°çš„`props`ä¼ é€’æ–¹æ¡ˆè‡ªç„¶ä¸åˆé€‚ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬é€šè¿‡`WeakMap`æ¥å®ç°`path`è·å–ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸¤ä¸ª`WeakMap`å°±å¯ä»¥å®ç°`findPath`çš„åŠŸèƒ½ï¼Œ`NODE_TO_INDEX`ç”¨äºå­˜å‚¨èŠ‚ç‚¹ä¸ç´¢å¼•çš„æ˜ å°„å…³ç³»ï¼Œ`NODE_TO_PARENT`ç”¨äºå­˜å‚¨èŠ‚ç‚¹ä¸çˆ¶èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ã€‚é€šè¿‡è¿™ä¸¤ä¸ª`WeakMap`å°±å¯ä»¥å®ç°`path`çš„æŸ¥æ‰¾ï¼Œæ¯æ¬¡æ›´æ–°èŠ‚ç‚¹æ—¶ï¼Œè¾ƒä½ç´¢å¼•çš„æ˜ å°„å…³ç³»éƒ½å¯ä»¥æ›´æ–°ã€‚

```js
// packages/immer-ot-json/src/components/list.tsx
const children = useMemo(() => {
  const children: JSX.Element[] = [];
  const path = findPath(currentNode);
  for (let i = 0; i < nodes.length; ++i) {
    const p = path.concat(i);
    const n = nodes[i];
    NODE_TO_INDEX.set(n, i);
    NODE_TO_PARENT.set(n, currentNode);
    children.push(<NodeModel node={n}></NodeModel>);
  }
  return children;
}, [currentNode, nodes, selection]);
```

é‚£ä¹ˆåœ¨å®é™…æŸ¥æ‰¾`path`çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä»ç›®æ ‡èŠ‚ç‚¹é€šè¿‡`NODE_TO_PARENT`å¼€å§‹ä¸æ–­æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹èŠ‚ç‚¹ä¸ºæ­¢ã€‚è€Œåœ¨è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡`NODE_TO_INDEX`æ¥è·å–`path`ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦é€šè¿‡å±‚çº§çº§åˆ«çš„éå†å°±å¯ä»¥æŸ¥æ‰¾åˆ°`path`ï¼Œè€Œä¸éœ€è¦éå†æ•´ä¸ªçŠ¶æ€æ ‘ã€‚

```js
// packages/immer-ot-json/src/utils/path.ts
export const findPath = (node: Node | Editor) => {
  const path: number[] = [];
  let child = node;
  // eslint-disable-next-line no-constant-condition
  while (true) {
    if (child instanceof Editor) {
      return path;
    }
    const parent = NODE_TO_PARENT.get(child);
    if (isNil(parent)) {
      break;
    }
    const i = NODE_TO_INDEX.get(child);
    if (isNil(i)) {
      break;
    }
    path.unshift(i);
    child = parent as Node;
  }
  throw new Error("Unable To Find Path");
};
```

é‚£ä¹ˆå®é™…ä¸Šæˆ‘ä»¬ä¹Ÿå¯ä»¥æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ›´æ–°`path`å€¼æ—¶æ˜¯éœ€è¦æ¸²æŸ“è¿‡ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æƒ³è¦è·å–æœ€æ–°çš„`path`ï¼Œå¿…é¡»è¦åœ¨æ¸²æŸ“å®Œæˆåæ‰å¯ä»¥ã€‚å› æ­¤æˆ‘ä»¬çš„æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹æ—¶åºå¿…é¡»è¦æ§åˆ¶å¥½ï¼Œå¦åˆ™ä¼šå¯¼è‡´è·å–ä¸åˆ°æœ€æ–°çš„`path`ï¼Œå› æ­¤é€šå¸¸æˆ‘ä»¬è¿˜éœ€è¦åœ¨`useEffect`æ¥åˆ†å‘æ¸²æŸ“å®Œæˆäº‹ä»¶ã€‚

è¿™é‡Œè¿˜éœ€è¦å…³æ³¨çš„æ˜¯ï¼Œç”±äºå®é™…ç¼–è¾‘å™¨å¼•æ“æ˜¯éœ€è¦ä¾èµ–`useEffect`æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»è¦æ‰€æœ‰çš„å­ç»„ä»¶æ¸²æŸ“å®Œæˆåæ‰è§¦å‘çˆ¶ç»„ä»¶çš„`effect`å‰¯ä½œç”¨ã€‚å› æ­¤åœ¨æ•´ä¸ªèŠ‚ç‚¹å¤–å±‚çš„`Context`çº§åˆ«æ¸²æŸ“èŠ‚ç‚¹ä¸èƒ½æ˜¯`React.lazy`çš„å®ç°ï¼Œå½“ç„¶å®é™…æ’ä»¶æ¸²æŸ“çš„å†…å®¹æ˜¯å¯ä»¥æ‡’åŠ è½½çš„ã€‚

```js
/**
 * è§†å›¾æ›´æ–°éœ€è¦è§¦å‘è§†å›¾ç»˜åˆ¶å®Œæˆäº‹ä»¶ æ— ä¾èµ–æ•°ç»„
 * state  -> parent -> node -> child ->|
 * effect <- parent <- node <- child <-|
 */
useEffect(() => {
  editor.logger.debug("OnPaint");
  editor.state.set(EDITOR_STATE.PAINTING, false);
  Promise.resolve().then(() => {
    editor.event.trigger(EDITOR_EVENT.PAINT, {});
  });
});
```

### é€‰åŒºçŠ¶æ€
selection hooks provider æŒ‰éœ€render 

### History
history å˜æ¢

## æ€»ç»“


## æ¯æ—¥ä¸€é¢˜

- <https://github.com/WindRunnerMax/EveryDay>

## å‚è€ƒ

- <https://github.com/ottypes/docs>
- <https://github.com/immerjs/immer>
- <https://github.com/ottypes/json0>
- <https://zhuanlan.zhihu.com/p/602961293>
- <https://github.com/ianstormtaylor/slate/>
- <https://stackoverflow.com/questions/34385243/why-is-immutability-so-important-or-needed-in-javascript>

