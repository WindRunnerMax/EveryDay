# æµè§ˆå™¨æ‰©å±•å¼€å‘çš„ç›¸å…³é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
æˆ‘å¼€å‘çš„æµè§ˆå™¨æ‰©å±•å®‰è£…é‡ç»ˆäºè¿‡åƒäº†ï¼åœ¨ [Firefox AddOns](https://addons.mozilla.org/en-US/firefox/addon/force-copy/) å·²ç»æœ‰`1.7k+`å®‰è£…ï¼Œåœ¨ [Chrome WebStore](https://chromewebstore.google.com/detail/force-copy/cceclgeciefpanebkfkogecbjjchmico) å·²ç»æœ‰`1k+`å®‰è£…ã€‚å®é™…ä¸Šåœ¨`Firefox`çš„æ‰©å±•å¸‚åœºé‡Œæ˜¯å‘¨å¹³å‡å®‰è£…é‡ï¼Œå½“å¤©çš„å®é™…å®‰è£…é‡è¦é«˜å‡ºå¹³å‡å€¼ä¸å°‘ï¼Œè€Œ`Chrome`çš„æ‰©å±•å¸‚åœºåœ¨è¶…è¿‡`1k`å®‰è£…é‡ä¹‹åå°±ä¸ç²¾ç¡®æ˜¾ç¤ºå®‰è£…é‡äº†ï¼Œå®é™…å®‰è£…é‡ä¹Ÿä¼šé«˜äº`1k`ã€‚

å®é™…ä¸Šåœ¨æˆ‘åšæ‰©å±•ä¹‹å‰ï¼Œæˆ‘æ˜¯å®ç°äº†è„šæœ¬æ¥å¤„ç†ç›¸å…³çš„åŠŸèƒ½çš„ï¼Œè„šæœ¬åœ¨ [GreasyFork](https://greasyfork.org/zh-CN/scripts/405130) ä¸Šæœ‰ `2688k+`å®‰è£…é‡ï¼Œè€Œå®ç°æ‰©å±•çš„ä¸»è¦åŸå› æœ‰ä¸¤ä¸ª: ä¸€ä¸ªåŸå› æ˜¯æˆ‘ä¹Ÿæƒ³å­¦ä¹ ä¸€ä¸‹æ‰©å±•çš„å¼€å‘ï¼Œæˆ‘å‘ç°åœ¨å·¥ä½œä¸­çœŸçš„ä¼šæœ‰åº”ç”¨åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯è¦çªç ´æµè§ˆå™¨é™åˆ¶åšä¸€äº›ç‰¹æ®Šå·¥ä½œçš„æƒ…å†µä¸‹ï¼›å¦ä¸€ä¸ªåŸå› æ˜¯æˆ‘å‘ç°æœ‰å°†æˆ‘æ‰“åŒ…å‘å¸ƒåœ¨`GreasyFork`ä¸Šçš„`GPL`åè®®çš„ä»£ç ç›´æ¥å°è£…æˆæ’ä»¶å¹¶åŠ å…¥äº†å¹¿å‘Šï¼Œå°±è¿™ç«Ÿç„¶è¿˜æœ‰`400k+`å®‰è£…é‡ã€‚

å› æ­¤æˆ‘ä¹ŸåŸºäºè„šæœ¬èƒ½åŠ›å®ç°äº†æµè§ˆå™¨æ‹“å±•ï¼Œå¹¶ä¸”æ˜¯ä¸»è¦ä¸ºäº†å­¦ä¹ çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»é›¶æ­å»ºäº†æ•´ä¸ªå¼€å‘ç¯å¢ƒï¼Œä¹Ÿåœ¨å¤„ç†äº†å¾ˆå¤šå…¼å®¹æ€§æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥èŠèŠç›¸å…³é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆã€‚é¡¹ç›®åœ°å€ [GitHub](https://github.com/WindrunnerMax/TKScript) ï¼Œå¦‚æœè§‰å¾—ä¸é”™ï¼Œç‚¹ä¸ª`star`å§ ğŸ˜ ã€‚

## æ‰©å±•æ‰“åŒ…æ–¹æ¡ˆ
æˆ‘ä»¬åœ¨å…ˆå‰æåˆ°äº†åœ¨è¿™é‡Œæ˜¯ä»é›¶æ­å»ºçš„å¼€å‘ç¯å¢ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æŒ‘é€‰ä¸€ä¸ªæ‰©å±•æ‰“åŒ…å·¥å…·ï¼Œåœ¨è¿™é‡Œæˆ‘é€‰ç”¨çš„æ˜¯`rspack`ï¼Œå½“ç„¶å¦‚æœæˆ‘ä»¬ä½¿ç”¨`webpack`æˆ–è€…æ˜¯`rollup`éƒ½æ˜¯æ²¡é—®é¢˜çš„ï¼Œåªæ˜¯ç”¨`rspack`æ¯”è¾ƒç†Ÿæ‚‰ä¸”æ‰“åŒ…é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œæ— è®ºæ˜¯å“ªç§æ‰“åŒ…å™¨éƒ½æ˜¯ç±»ä¼¼çš„é…ç½®ã€‚æ­¤å¤–ï¼Œåœ¨è¿™é‡Œå®é™…ä¸Šæˆ‘ä»¬æ˜¯ä½¿ç”¨çš„`build`çº§åˆ«çš„æ‰“åŒ…æ–¹å¼ï¼Œç±»ä¼¼äº`devserver`çš„æ–¹æ¡ˆåœ¨`v3`ä¸­ç›®å‰å¹¶ä¸å¤ªé€‚ç”¨ã€‚

é‚£ä¹ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨æ‰©å±•ä¸­æˆ‘ä»¬éœ€è¦å®šä¹‰å¤šä¸ªå…¥å£æ–‡ä»¶ï¼Œå¹¶ä¸”éœ€è¦å•æ–‡ä»¶çš„æ‰“åŒ…æ–¹æ¡ˆï¼Œä¸èƒ½å‡ºç°å•å…¥å£å¤šä¸ª`chunk`ï¼ŒåŒ…æ‹¬`CSS`æˆ‘ä»¬ä¹Ÿéœ€è¦æ‰“åŒ…ä¸ºå•å…¥å£å•è¾“å‡ºï¼Œå¹¶ä¸”è¾“å‡ºçš„æ–‡ä»¶åä¹Ÿä¸è¦å¸¦`hash`çš„åç¼€ï¼Œé˜²æ­¢æ–‡ä»¶æ‰¾ä¸åˆ°çš„æƒ…å†µã€‚ä¸è¿‡è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆæ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æ³¨æ„å³å¯ã€‚

```js
module.exports = {
  context: __dirname,
  entry: {
    popup: "./src/popup/index.tsx",
    content: "./src/content/index.ts",
    worker: "./src/worker/index.ts",
    [INJECT_FILE]: "./src/inject/index.ts",
  },
  // ...
  output: {
    publicPath: "/",
    filename: "[name].js",
    path: path.resolve(__dirname, folder),
  },
}
```

åœ¨è¿™é‡Œå¯ä»¥å‘ç°`INJECT_FILE`çš„è¾“å‡ºæ–‡ä»¶åæ˜¯ä¸ªåŠ¨æ€çš„ï¼Œåœ¨è¿™é‡Œç”±äº`inject`è„šæœ¬æ˜¯éœ€è¦æ³¨å…¥åˆ°æµè§ˆå™¨é¡µé¢ä¸Šçš„ï¼Œç”±äºæ³¨å…¥æ–¹æ¡ˆçš„å…³ç³»ï¼Œåœ¨æµè§ˆå™¨é¡µé¢ä¸Šå°±å¯èƒ½å‘ç”Ÿå†²çªï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬æ¯æ¬¡`build`ç”Ÿæˆçš„æ–‡ä»¶åéƒ½æ˜¯ä¸ä¸€è‡´çš„ï¼Œåœ¨æ¯æ¬¡å‘å¸ƒåæ–‡ä»¶åéƒ½ä¼šæ›´æ”¹ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿçš„äº‹ä»¶é€šä¿¡æ–¹æ¡ˆä¹Ÿæ˜¯ä¸€è‡´éšæœºåã€‚

```js
const EVENT_TYPE = isDev ? "EVENT_TYPE" : getUniqueId();
const INJECT_FILE = isDev ? "INJECT_FILE" : getUniqueId();

process.env.EVENT_TYPE = EVENT_TYPE;
process.env.INJECT_FILE = INJECT_FILE;
// ...

module.exports = {
  context: __dirname,
  builtins: {
    define: {
      "__DEV__": JSON.stringify(isDev),
      "process.env.EVENT_TYPE": JSON.stringify(process.env.EVENT_TYPE),
      "process.env.INJECT_FILE": JSON.stringify(process.env.INJECT_FILE),
      // ...
    }
  }
  // ...
}
```


## Chromeä¸Firefoxå…¼å®¹
`Chrome`ä¸€ç›´åœ¨å¼ºæ¨æ‰©å±•çš„`V3`ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯`manifest_version`éœ€è¦æ ‡è®°ä¸º`3`ï¼Œè€Œåœ¨`Firefox`ä¸­æäº¤`manifest_version: 3`çš„ç‰ˆæœ¬ä¼šå¾—åˆ°ä¸å»ºè®®ä½¿ç”¨çš„æç¤ºã€‚å®é™…ä¸Šå¯¹äºä¸ªäººè€Œè¨€æˆ‘ä¹Ÿä¸å–œæ¬¢ä½¿ç”¨`v3`ç‰ˆæœ¬ï¼Œé™åˆ¶ç‰¹åˆ«å¤šï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½æ²¡æœ‰åŠæ³•æ­£å¸¸å®ç°ï¼Œè¿™ç‚¹æˆ‘ä»¬åè¾¹å†èŠã€‚é‚£ä¹ˆæ—¢ç„¶`Chrome`å¼ºåˆ¶æ€§ç”¨`v3`ï¼Œ`Firefox`æ¨èç”¨`v2`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åˆ†åˆ«åœ¨`Chromium`å†…æ ¸å’Œ`Gecko`å†…æ ¸ä¸­å®ç°å…¼å®¹æ–¹æ¡ˆã€‚


å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥å‘ç°è¿™æ˜¯ä¸æ˜¯å¾ˆåƒå¤šç«¯æ„å»ºçš„åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦å°†åŒä¸€ä»½ä»£ç åœ¨å¤šä¸ªå¹³å°æ‰“åŒ…ã€‚é‚£ä¹ˆåœ¨å¤„ç†ä¸€äº›è·¨å¹³å°çš„ç¼–è¯‘é—®é¢˜æ—¶ï¼Œæˆ‘æœ€å¸¸ç”¨çš„çš„æ–¹æ³•å°±æ˜¯`process.env`ä¸`__DEV__`ï¼Œä½†æ˜¯åœ¨ç”¨å¤šäº†ä¹‹åå‘ç°ï¼Œåœ¨è¿™ç§ç±»ä¼¼äºæ¡ä»¶ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œå¤§é‡ä½¿ç”¨`process.env.PLATFORM === xxx`å¾ˆå®¹æ˜“å‡ºç°æ·±å±‚æ¬¡åµŒå¥—çš„é—®é¢˜ï¼Œå¯è¯»æ€§ä¼šå˜å¾—å¾ˆå·®ï¼Œæ¯•ç«Ÿæˆ‘ä»¬çš„`Promise`å°±æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥å›è°ƒçš„åµŒå¥—åœ°ç‹±çš„é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬å› ä¸ºéœ€è¦è·¨å¹³å°ç¼–è¯‘è€Œç»§ç»­å¼•å…¥åµŒå¥—é—®é¢˜çš„è¯ï¼Œæ€»æ„Ÿè§‰å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆã€‚

åœ¨`C/C++`ä¸­æœ‰ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„é¢„å¤„ç†å™¨ï¼Œ`C Preprocessor`ä¸æ˜¯ç¼–è¯‘å™¨çš„ç»„æˆéƒ¨åˆ†ï¼Œä½†å…¶æ˜¯ç¼–è¯‘è¿‡ç¨‹ä¸­ä¸€ä¸ªå•ç‹¬çš„æ­¥éª¤ï¼Œç®€å•æ¥è¯´`C Preprocessor`ç›¸å½“äºæ˜¯ä¸€ä¸ªæ–‡æœ¬æ›¿æ¢å·¥å…·ï¼Œä¾‹å¦‚ä¸åŠ å…¥æ ‡è¯†ç¬¦çš„å®å‚æ•°ç­‰éƒ½æ˜¯åŸå§‹æ–‡æœ¬ç›´æ¥æ›¿æ¢ï¼Œå¯ä»¥æŒ‡ç¤ºç¼–è¯‘å™¨åœ¨å®é™…ç¼–è¯‘ä¹‹å‰å®Œæˆæ‰€éœ€çš„é¢„å¤„ç†ã€‚`#include`ã€`#define`ã€`#ifdef`ç­‰ç­‰éƒ½å±äº`C Preprocessor`çš„é¢„å¤„ç†å™¨æŒ‡ä»¤ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨æ¡ä»¶ç¼–è¯‘çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯`#if`ã€`#endif`ã€`#ifdef`ã€`#endif`ã€`#ifndef`ã€`#endif`ç­‰æ¡ä»¶ç¼–è¯‘æŒ‡ä»¤ã€‚

```c
#if VERBOSE >= 2
  print("trace message");
#endif

#ifdef __unix__ /* __unix__ is usually defined by compilers targeting Unix systems */
# include <unistd.h>
#elif defined _WIN32 /* _WIN32 is usually defined by compilers targeting 32 or 64 bit Windows systems */
# include <windows.h>
#endif
```

é‚£ä¹ˆæˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥å°†ç±»ä¼¼çš„æ–¹å¼å€ŸåŠ©æ„å»ºå·¥å…·æ¥å®ç°ï¼Œé¦–å…ˆ`C Preprocessor`æ˜¯ä¸€ä¸ªé¢„å¤„ç†å·¥å…·ï¼Œä¸å‚ä¸å®é™…çš„ç¼–è¯‘æ—¶çš„è¡Œä¸ºï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±å¾ˆåƒ`webpack`ä¸­çš„`loader`ï¼Œè€ŒåŸå§‹æ–‡æœ¬çš„ç›´æ¥æ›¿æ¢æˆ‘ä»¬åœ¨`loader`ä¸­ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥åšåˆ°çš„ï¼Œè€Œç±»ä¼¼äº`#ifdef`ã€`#endif`æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨é‡Šçš„å½¢å¼æ¥å®ç°ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ·±å±‚æ¬¡çš„åµŒå¥—é—®é¢˜ï¼Œè€Œå­—ç¬¦ä¸²æ›¿æ¢çš„ç›¸å…³é€»è¾‘æ˜¯å¯ä»¥ç›´æ¥ä¿®æ”¹åŸæ¥æ¥å¤„ç†ï¼Œä¾‹å¦‚ä¸ç¬¦åˆå¹³å°æ¡ä»¶çš„å°±å¯ä»¥ç§»é™¤æ‰ï¼Œç¬¦åˆå¹³å°æ¡ä»¶çš„å°±å¯ä»¥ä¿ç•™ä¸‹æ¥ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ç±»ä¼¼äº`#ifdef`ã€`#endif`çš„æ•ˆæœäº†ã€‚æ­¤å¤–ï¼Œé€šè¿‡æ³¨é‡Šæ¥å®ç°å¯¹æŸäº›å¤æ‚åœºæ™¯è¿˜æ˜¯æœ‰å¸®åŠ©çš„ï¼Œä¾‹å¦‚æˆ‘å°±é‡åˆ°è¿‡æ¯”è¾ƒå¤æ‚çš„`SDK`æ‰“åŒ…åœºæ™¯ï¼Œå¯¹å†…ä¸å¯¹å¤–ä»¥åŠå¯¹æœ¬ä½“é¡¹ç›®å¹³å°çš„è¡Œä¸ºéƒ½æ˜¯ä¸ä¸€è‡´çš„ï¼Œå¦‚æœåœ¨ä¸æ„å»ºå¤šä¸ªåŒ…çš„æƒ…å†µä¸‹ï¼Œè·¨å¹³å°å°±éœ€è¦ç”¨æˆ·è‡ªå·±æ¥é…ç½®æ„å»ºå·¥å…·ï¼Œè€Œä½¿ç”¨æ³¨é‡Šå¯ä»¥åœ¨ä¸é…ç½®`loader`çš„æƒ…å†µä¸‹åŒæ ·èƒ½å¤Ÿå®Œæ•´æ‰“åŒ…ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥é¿å…ç”¨æˆ·éœ€è¦æ”¹åŠ¨è‡ªå·±çš„é…ç½®ï¼Œå½“ç„¶è¿™ç§æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒæ·±åœ°è€¦åˆåœ¨ä¸šåŠ¡åœºæ™¯çš„ï¼Œåªæ˜¯æä¾›ä¸€ç§æƒ…å†µçš„å‚è€ƒã€‚

```js
// #IFDEF CHROMIUM
console.log("IS IN CHROMIUM");
// #ENDIF

// #IFDEF GECKO
console.log("IS IN GECKO");
// #ENDIF
```

æœ€å¼€å§‹çš„æ—¶å€™æˆ‘æƒ³ä½¿ç”¨æ­£åˆ™çš„æ–¹å¼ç›´æ¥è¿›è¡Œå¤„ç†çš„ï¼Œä½†æ˜¯å‘ç°å¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå°¤å…¶æ˜¯å­˜åœ¨åµŒå¥—çš„æƒ…å†µä¸‹ï¼Œå°±ä¸å¤ªå®¹æ˜“å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå†åæ¥æˆ‘æƒ³åæ­£ä»£ç éƒ½æ˜¯ ä¸€è¡Œä¸€è¡Œçš„é€»è¾‘ï¼ŒæŒ‰è¡Œå¤„ç†çš„æ–¹å¼æ‰æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­å› ä¸ºæœ¬èº«å°±æ˜¯æ³¨é‡Šï¼Œæœ€ç»ˆéƒ½æ˜¯è¦åˆ é™¤çš„ï¼Œå³ä½¿å­˜åœ¨ç¼©è¿›çš„æƒ…å†µç›´æ¥å»æ‰å‰åçš„ç©ºç™½å°±èƒ½ç›´æ¥åŒ¹é…æ ‡è®°è¿›è¡Œå¤„ç†äº†ã€‚è¿™æ ·æ€è·¯å°±å˜çš„ç®€å•äº†å¾ˆå¤šï¼Œé¢„å¤„ç†æŒ‡ä»¤èµ·å§‹`#IFDEF`åªä¼šç½®`true`ï¼Œé¢„å¤„ç†æŒ‡ä»¤ç»“æŸ`#ENDIF`åªä¼šç½®`false`ï¼Œè€Œæˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡å®é™…ä¸Šå°±æ˜¯åˆ é™¤ä»£ç ï¼Œæ‰€ä»¥å°†ä¸ç¬¦åˆæ¡ä»¶åˆ¤æ–­çš„ä»£ç è¡Œè¿”å›ç©ºç™½å³å¯ï¼Œä½†æ˜¯å¤„ç†åµŒå¥—çš„æ—¶å€™è¿˜æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ˆæ¥è®°å½•å½“å‰çš„å¤„ç†é¢„å¤„ç†æŒ‡ä»¤èµ·å§‹`#IFDEF`çš„ç´¢å¼•å³è¿›æ ˆï¼Œå½“é‡åˆ°`#ENDIF`å†å‡ºæ ˆï¼Œå¹¶ä¸”è¿˜éœ€è¦è®°å½•å½“å‰çš„å¤„ç†çŠ¶æ€ï¼Œå¦‚æœå½“å‰çš„å¤„ç†çŠ¶æ€æ˜¯`true`ï¼Œé‚£ä¹ˆåœ¨å‡ºæ ˆçš„æ—¶å€™å°±éœ€è¦ç¡®å®šæ˜¯å¦éœ€è¦æ ‡è®°å½“å‰çŠ¶æ€ä¸º`false`ä»è€Œç»“æŸå½“å‰å—çš„å¤„ç†ï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡`debug`æ¥å®ç°å¯¹äºå‘½ä¸­æ¨¡å—å¤„ç†åæ–‡ä»¶çš„ç”Ÿæˆã€‚

```js
// CURRENT PLATFORM: GECKO

// #IFDEF CHROMIUM
// some expressions... // remove
// #ENDIF

// #IFDEF GECKO
// some expressions... // retain
// #ENDIF

// #IFDEF CHROMIUM
// some expressions... // remove
// #IFDEF GECKO
// some expressions... // remove
// #ENDIF
// #ENDIF

// #IFDEF GECKO
// some expressions... // retain
// #IFDEF CHROMIUM
// some expressions... // remove
// #ENDIF
// #ENDIF

// #IFDEF CHROMIUM|GECKO
// some expressions... // retain
// #IFDEF GECKO
// some expressions... // retain
// #ENDIF
// #ENDIF
```

```js
// ...
// è¿­ä»£æ—¶æ§åˆ¶è¯¥è¡Œæ˜¯å¦å‘½ä¸­é¢„å¤„ç†æ¡ä»¶
const platform = (process.env[envKey] || "").toLowerCase();
let terser = false;
let revised = false;
let terserIndex = -1;
/** @type {number[]} */
const stack = [];
const lines = source.split("\n");
const target = lines.map((line, index) => {
// å»æ‰é¦–å°¾çš„ç©ºç™½ å»æ‰è¡Œé¦–æ³¨é‡Šç¬¦å·ä¸ç©ºç™½ç¬¦(å¯é€‰)
const code = line.trim().replace(/^\/\/\s*/, "");
// æ£€æŸ¥é¢„å¤„ç†æŒ‡ä»¤èµ·å§‹ `#IFDEF`åªä¼šç½®`true`
if (/^#IFDEF/.test(code)) {
  stack.push(index);
  // å¦‚æœæ˜¯`true`ç»§ç»­å³å¯
  if (terser) return "";
  const match = code.replace("#IFDEF", "").trim();
  const group = match.split("|").map(item => item.trim().toLowerCase());
  if (group.indexOf(platform) === -1) {
    terser = true;
    revised = true;
    terserIndex = index;
  }
  return "";
}
// æ£€æŸ¥é¢„å¤„ç†æŒ‡ä»¤ç»“æŸ `#IFDEF`åªä¼šç½®`false`
if (/^#ENDIF$/.test(code)) {
  const index = stack.pop();
  // é¢å¤–çš„`#ENDIF`å¿½ç•¥
  if (index === undefined) return "";
  if (index === terserIndex) {
    terser = false;
    terserIndex = -1;
  }
  return "";
}
// å¦‚æœå‘½ä¸­é¢„å¤„ç†æ¡ä»¶åˆ™æ“¦é™¤
if (terser) return "";
  return line;
});
// ...
```

é‚£ä¹ˆåœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä»¥è°ƒç”¨æ³¨å†Œ`Badge`ä¸ºä¾‹ï¼Œé€šè¿‡`if`åˆ†æ”¯å°†ä¸åŒç«¯çš„ä»£ç åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œå½“ç„¶å¦‚æœæœ‰ç±»ä¼¼çš„å®šä¹‰ï¼Œä¹Ÿå¯ä»¥æ–¹ä¾¿åœ°ç›´æ¥é‡æ–°å®šä¹‰å˜é‡å³å¯ã€‚

```js
let env = chrome;
// #IFDEF GECKO
if (typeof browser !== "undefined") {
  env = browser;
}
// #ENDIF
export const cross = env;

// ...
let action: typeof cross.action | typeof cross.browserAction = cross.action;
// #IFDEF GECKO
action = cross.browserAction;
// #ENDIF
action.setBadgeText({ text: payload.toString(), tabId });
action.setBadgeBackgroundColor({ color: "#4e5969", tabId });
```

## å…ˆäºé¡µé¢Jsä»£ç æ‰§è¡Œ
æµè§ˆå™¨æ‰©å±•çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½å°±æ˜¯`document_start`ï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨æ³¨å…¥çš„ä»£ç è¦å…ˆäºç½‘ç«™æœ¬èº«çš„`Js`ä»£ç æ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥ä¸ºæˆ‘ä»¬çš„ä»£ç ç•™äºˆå……åˆ†çš„`Hook`ç©ºé—´ï¼Œè¯•æƒ³ä¸€ä¸‹å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨é¡µé¢å®é™…åŠ è½½çš„æ—¶å€™å°±è¿è¡Œæˆ‘ä»¬æƒ³æ‰§è¡Œçš„`Js`ä»£ç çš„è¯ï¼Œå²‚ä¸æ˜¯å¯ä»¥å¯¹å½“å‰çš„é¡µé¢ä¸ºæ‰€æ¬²ä¸ºäº†ã€‚è™½ç„¶æˆ‘ä»¬ä¸èƒ½å¤Ÿ`Hook`è‡ªé¢é‡çš„åˆ›å»ºï¼Œä½†æ˜¯æˆ‘ä»¬æ€»å¾—è°ƒç”¨æµè§ˆå™¨æä¾›çš„`API`ï¼Œåªè¦ç”¨`API`çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æƒ³åŠæ³•æ¥åŠ«æŒæ‰å‡½æ•°çš„è°ƒç”¨ï¼Œä»è€Œæ‹¿åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œä¾‹å¦‚å¯ä»¥åŠ«æŒ`Function.prototype.call`å‡½æ•°çš„è°ƒç”¨ï¼Œè€Œè¿™ä¸ªå‡½æ•°èƒ½å¤Ÿå®Œæˆå¾ˆå¤§ç¨‹åº¦ä¸Šå°±éœ€è¦ä¾èµ–æˆ‘è¿™ä¸ªåŠ«æŒå‡½æ•°åœ¨æ•´ä¸ªé¡µé¢æ˜¯è¦æœ€å…ˆæ”¯æŒçš„ï¼Œå¦åˆ™è¿™ä¸ªå‡½æ•°å·²ç»è¢«è°ƒç”¨è¿‡å»äº†ï¼Œé‚£ä¹ˆå†åŠ«æŒå°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ã€‚

```js
Function.prototype.call = function (dynamic, ...args) {
  const context = Object(dynamic) || window;
  const symbol = Symbol();
  context[symbol] = this;
  args.length === 2 && console.log(args);
  try {
    const result = context[symbol](...args);
    delete context[symbol];
    return result;
  } catch (error) {
    console.log("Hook Call Error", error);
    console.log(context, context[symbol], this, dynamic, args);
    return null;
  }
};
```

é‚£ä¹ˆå¯èƒ½æˆ‘ä»¬å¤§å®¶ä¼šæƒ³è¿™ä¸ªä»£ç çš„å®ç°æ„ä¹‰åœ¨ä½•å¤„ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„å®è·µï¼Œåœ¨æŸæŸæ–‡åº“ä¸­æ‰€æœ‰çš„æ–‡å­—éƒ½æ˜¯é€šè¿‡`canvas`æ¸²æŸ“çš„ï¼Œå› ä¸ºæ²¡æœ‰`DOM`é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è·å¾—æ–‡æ¡£çš„æ•´ç¯‡å†…å®¹æ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥å¤åˆ¶çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆæ˜¯åŠ«æŒ`document.createElement`å‡½æ•°ï¼Œå½“åˆ›å»ºçš„å…ƒç´ æ˜¯`canvas`æ—¶æˆ‘ä»¬å°±å¯ä»¥æå‰æ‹¿åˆ°ç”»å¸ƒçš„å¯¹è±¡ï¼Œä»è€Œæ‹¿åˆ°`ctx`ï¼Œè€Œåˆå› ä¸ºå®é™…ç»˜åˆ¶æ–‡å­—æ€»å½’è¿˜æ˜¯è¦è°ƒç”¨`context2DPrototype.fillText`æ–¹æ³•çš„ï¼Œæ‰€ä»¥å†åŠ«æŒåˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å°±èƒ½å°†ç»˜åˆ¶çš„æ–‡å­—æ‹¿å‡ºæ¥ï¼Œç´§æ¥ç€å°±å¯ä»¥è‡ªè¡Œåˆ›å»º`DOM`ç”»åœ¨åˆ«å¤„ï¼Œæƒ³å¤åˆ¶å°±å¯ä»¥å¤åˆ¶äº†ã€‚

é‚£ä¹ˆæˆ‘ä»¬å›åˆ°è¿™ä¸ªé—®é¢˜çš„å®ç°ä¸Šï¼Œå¦‚æœèƒ½å¤Ÿä¿è¯è„šæœ¬æ˜¯æœ€å…ˆæ‰§è¡Œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡ ä¹å¯ä»¥åšåˆ°åœ¨è¯­è¨€å±‚é¢ä¸Šçš„ä»»ä½•äº‹æƒ…ï¼Œä¾‹å¦‚ä¿®æ”¹`window`å¯¹è±¡ã€`Hook`å‡½æ•°å®šä¹‰ã€ä¿®æ”¹åŸå‹é“¾ã€é˜»æ­¢äº‹ä»¶ç­‰ç­‰ç­‰ç­‰ã€‚å…¶æœ¬èº«çš„èƒ½åŠ›ä¹Ÿæ˜¯æºè‡ªäºæµè§ˆå™¨æ‹“å±•ï¼Œè€Œå¦‚ä½•å°†æµè§ˆå™¨æ‰©å±•çš„è¿™ä¸ªèƒ½åŠ›æš´éœ²ç»™`Web`é¡µé¢å°±æ˜¯è„šæœ¬ç®¡ç†å™¨éœ€è¦è€ƒé‡çš„é—®é¢˜äº†ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œå‡è®¾ç”¨æˆ·è„šæœ¬æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨é¡µé¢çš„`Inject Script`è€Œä¸æ˜¯`Content Script`ï¼ŒåŸºäºè¿™ä¸ªå‡è®¾ï¼Œé¦–å…ˆæˆ‘ä»¬å¤§æ¦‚ç‡ä¼šå†™è¿‡åŠ¨æ€/å¼‚æ­¥åŠ è½½`JS`è„šæœ¬çš„å®ç°ï¼Œç±»ä¼¼äºä¸‹é¢è¿™ç§æ–¹å¼:

```js
const loadScriptAsync = (url: string) => {
    return new Promise<Event>((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url;
        script.async = true;
        script.onload = e => {
            script.remove();
            resolve(e);
        };
        script.onerror = e => {
            script.remove();
            reject(e);
        };
        document.body.appendChild(script);
    });
};
```

é‚£ä¹ˆç°åœ¨å°±æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¦‚æœåœ¨`body`æ ‡ç­¾æ„å»ºå®Œæˆä¹Ÿå°±æ˜¯å¤§æ¦‚åœ¨`DOMContentLoaded`æ—¶æœºå†åŠ è½½è„šæœ¬è‚¯å®šæ˜¯è¾¾ä¸åˆ°`document-start`çš„ç›®æ ‡çš„ï¼Œå³ä½¿æ˜¯åœ¨`head`æ ‡ç­¾å®Œæˆä¹‹åå¤„ç†ä¹Ÿä¸è¡Œï¼Œå¾ˆå¤šç½‘ç«™éƒ½ä¼šåœ¨`head`å†…ç¼–å†™éƒ¨åˆ†`JS`èµ„æºï¼Œåœ¨è¿™é‡ŒåŠ è½½åŒæ ·æ—¶æœºå·²ç»ä¸åˆé€‚äº†ï¼Œå®é™…ä¸Šæœ€å¤§çš„é—®é¢˜è¿˜æ˜¯æ•´ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨æ•´ä¸ªå¤–éƒ¨è„šæœ¬åŠ è½½å®Œæˆä¹‹å‰å·²ç»æœ‰å¾ˆå¤š`JS`ä»£ç åœ¨æ‰§è¡Œäº†ï¼Œåšä¸åˆ°æˆ‘ä»¬æƒ³è¦çš„â€œæœ€å…ˆæ‰§è¡Œâ€ã€‚

é‚£ä¹ˆä¸‹è½½æˆ‘ä»¬å°±æ¥æ¢ç©¶å…·ä½“çš„å®ç°ï¼Œé¦–å…ˆæ˜¯`v2`çš„æ‰©å±•ä¹Ÿå°±æ˜¯åœ¨`gecko`å†…æ ¸çš„æµè§ˆå™¨ä¸Šï¼Œå¯¹äºæ•´ä¸ªé¡µé¢æ¥è¯´ï¼Œæœ€å…ˆåŠ è½½çš„å¿…å®šæ˜¯`html`è¿™ä¸ªæ ‡ç­¾ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾æˆ‘ä»¬åªè¦å°†è„šæœ¬åœ¨`html`æ ‡ç­¾çº§åˆ«æ’å…¥å°±å¥½äº†ï¼Œé…åˆæµè§ˆå™¨æ‰©å±•ä¸­`background`çš„`chrome.tabs.executeScript`åŠ¨æ€æ‰§è¡Œä»£ç ä»¥åŠ`Content Script`çš„`"run_at": "document_start"`å»ºç«‹æ¶ˆæ¯é€šä¿¡ç¡®è®¤æ³¨å…¥çš„`tab`ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä½†å°±æ˜¯è¿™ä¹ˆç®€å•çš„é—®é¢˜è®©æˆ‘æ€ç´¢äº†å¾ˆä¹…æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚

```js
// Content Script --> Background
// Background -> chrome.tabs.executeScript
chrome.tabs.executeScript(sender.tabId, {
  frameId: sender.frameId,
  code: `(function(){
    let temp = document.createElementNS("http://www.w3.org/1999/xhtml", "script");
        temp.setAttribute('type', 'text/javascript');
        temp.innerHTML = "${script.code}";
        temp.className = "injected-js";
        document.documentElement.appendChild(temp);
        temp.remove();
    }())`,
  runAt,
});
```

è¿™ä¸ªçœ‹èµ·æ¥å…¶å®å·²ç»è¿˜ä¸é”™äº†ï¼Œèƒ½å¤ŸåŸºæœ¬åšåˆ°`document-start`ï¼Œä½†æ—¢ç„¶éƒ½è¯´äº†æ˜¯åŸºæœ¬ï¼Œè¯´æ˜è¿˜æœ‰äº›æƒ…å†µä¼šå‡ºé—®é¢˜ï¼Œæˆ‘ä»¬ä»”ç»†çœ‹è¿™ä¸ªä»£ç çš„å®ç°ï¼Œåœ¨è¿™é‡Œæœ‰ä¸€ä¸ªé€šä¿¡ä¹Ÿå°±æ˜¯`Content Script --> Background`ï¼Œæ—¢ç„¶æ˜¯é€šä¿¡é‚£ä¹ˆå°±æ˜¯å¼‚æ­¥å¤„ç†çš„ï¼Œæ—¢ç„¶æ˜¯å¼‚æ­¥å¤„ç†å°±ä¼šæ¶ˆè€—æ—¶é—´ï¼Œä¸€æ—¦æ¶ˆè€—æ—¶é—´é‚£ä¹ˆç”¨æˆ·é¡µé¢å°±å¯èƒ½å·²ç»æ‰§è¡Œäº†å¤§é‡çš„ä»£ç äº†ï¼Œæ‰€ä»¥è¿™ä¸ªå®ç°ä¼šå¶ç°æ— æ³•åšåˆ°`document-start`çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å®é™…ä¸Šæ˜¯ä¼šå‡ºç°è„šæœ¬å¤±æ•ˆçš„æƒ…å†µã€‚

é‚£ä¹ˆæœ‰ä»€ä¹ˆåŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œåœ¨`v2`ä¸­æˆ‘ä»¬èƒ½å¤Ÿæ˜ç¡®çŸ¥é“çš„æ˜¯`Content Script`æ˜¯å®Œå…¨å¯æ§çš„`document-start`ï¼Œä½†æ˜¯`Content Script`å¹¶ä¸æ˜¯`Inject Script`ï¼Œæ²¡æœ‰åŠæ³•è®¿é—®åˆ°é¡µé¢çš„`window`å¯¹è±¡ï¼Œä¹Ÿå°±æ²¡æœ‰åŠæ³•å®é™…åŠ«æŒé¡µé¢çš„å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œå®é™…ä¸Šæƒ³æ˜ç™½ä¹‹åè§£å†³èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨åŸæœ¬çš„`Content Script`çš„åŸºç¡€ä¸Šï¼Œå†å¼•å…¥ä¸€ä¸ª`Content Script`ï¼Œè€Œè¿™ä¸ª`Content Script`çš„ä»£ç æ˜¯å®Œå…¨ç­‰åŒäºåŸæœ¬çš„`Inject Script`ï¼Œåªä¸è¿‡ä¼šæŒ‚åœ¨`window`ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©æ‰“åŒ…å·¥å…·å†™ä¸ªæ’ä»¶æ¥å®Œæˆè¿™ä»¶äº‹ã€‚

```js
compiler.hooks.emit.tapAsync("WrapperCodePlugin", (compilation, done) => {
  Object.keys(compilation.assets).forEach(key => {
    if (!isChromium && key === process.env.INJECT_FILE + ".js") {
      try {
        const buffer = compilation.assets[key].source();
        let code = buffer.toString("utf-8");
        code = `window.${process.env.INJECT_FILE}=function(){${code}}`;
        compilation.assets[key] = {
          source() {
            return code;
          },
          size() {
            return this.source().length;
          },
        };
      } catch (error) {
        console.log("Parse Inject File Error", error);
      }
    }
  });
  done();
});
```

è¿™æ®µä»£ç è¡¨ç¤ºäº†æˆ‘ä»¬åœ¨åŒæ ·çš„`Content Script`çš„`window`å¯¹è±¡ä¸ŠæŒ‚äº†ä¸€ä¸ªéšæœºç”Ÿæˆçš„`key`ï¼Œåœ¨è¿™é‡Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„å¯èƒ½ä¼šå¼•èµ·å†²çªçš„åœ°æ–¹ï¼Œè€Œå†…å®¹å°±æ˜¯æˆ‘ä»¬å®é™…æƒ³è¦æ³¨å…¥åˆ°é¡µé¢çš„è„šæœ¬ï¼Œä½†æ˜¯ç°åœ¨è™½ç„¶æˆ‘ä»¬èƒ½å¤Ÿæ‹¿åˆ°è¿™ä¸ªå‡½æ•°äº†ï¼Œæ€ä¹ˆèƒ½å¤Ÿè®©å…¶åœ¨ç”¨æˆ·é¡µé¢ä¸Šæ‰§è¡Œå‘¢ï¼Œè¿™é‡Œå®é™…ä¸Šæ˜¯ç”¨åˆ°äº†åŒæ ·çš„`document.documentElement.appendChild`åˆ›å»ºè„šæœ¬æ–¹æ³•ï¼Œä½†æ˜¯åœ¨è¿™é‡Œçš„å®ç°éå¸¸éå¸¸å·§å¦™ï¼Œæˆ‘ä»¬é€šè¿‡ä¸¤ä¸ª`Content Script`é…åˆ`toString`çš„æ–¹å¼æ‹¿åˆ°äº†å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å°†å…¶ä½œä¸ºä»£ç ç›´æ¥æ³¨å…¥åˆ°äº†é¡µé¢ï¼Œä»è€Œåšåˆ°äº†çœŸæ­£çš„`document-start`ã€‚

```js
const fn = window[process.env.INJECT_FILE as unknown as number] as unknown as () => void;
// #IFDEF GECKO
if (fn) {
  const script = document.createElementNS("http://www.w3.org/1999/xhtml", "script");
  script.setAttribute("type", "text/javascript");
  script.innerText = `;(${fn.toString()})();`;
  document.documentElement.appendChild(script);
  script.onload = () => script.remove();
  // eslint-disable-next-line @typescript-eslint/ban-ts-comment
  // @ts-ignore
  delete window[process.env.INJECT_FILE];
}
// #ENDIF
```

å‰è¾¹ä¹Ÿæåˆ°äº†ç”±äºå®é™…ä¸Š`Chrome`æµè§ˆå™¨ä¸å†å…è®¸`v2`çš„æ‰©å±•ç¨‹åºæäº¤ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æäº¤`v3`çš„ä»£ç ï¼Œä½†æ˜¯`v3`çš„ä»£ç æœ‰ç€éå¸¸ä¸¥æ ¼çš„`CSP`å†…å®¹å®‰å…¨ç­–ç•¥çš„é™åˆ¶ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºä¸å…è®¸åŠ¨æ€åœ°æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸Šè¿°çš„æ–¹å¼å°±éƒ½å¤±æ•ˆäº†ï¼Œäºæ˜¯æˆ‘ä»¬åªèƒ½å†™å‡ºç±»ä¼¼ä¸‹é¢çš„ä»£ç ã€‚

```js
const script = document.createElementNS("http://www.w3.org/1999/xhtml", "script");
script.setAttribute("type", "text/javascript");
script.setAttribute("src", chrome.runtime.getURL("inject.js"));
document.documentElement.appendChild(script);
script.onload = () => script.remove();
```

è™½ç„¶çœ‹èµ·æ¥æˆ‘ä»¬ä¹Ÿæ˜¯åœ¨`Content Script`ä¸­ç«‹å³åˆ›å»ºäº†`Script`æ ‡ç­¾å¹¶ä¸”æ‰§è¡Œä»£ç ï¼Œè€Œä»–èƒ½å¤Ÿè¾¾åˆ°æˆ‘ä»¬çš„`document-start`ç›®æ ‡å—ï¼Œå¾ˆé—æ†¾ç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œåœ¨é¦–æ¬¡æ‰“å¼€é¡µé¢çš„æ—¶å€™æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯åœ¨ä¹‹åå› ä¸ºè¿™ä¸ªè„šæœ¬å®é™…ä¸Šæ˜¯ç›¸å½“äºæ‹¿åˆ°äº†ä¸€ä¸ªå¤–éƒ¨çš„è„šæœ¬ï¼Œå› æ­¤`Chrome`ä¼šå°†è¿™ä¸ªè„šæœ¬å’Œé¡µé¢ä¸Šå…¶ä»–çš„é¡µé¢åŒæ ·å¤„äºä¸€ä¸ªæ’é˜Ÿçš„çŠ¶æ€ï¼Œè€Œå…¶ä»–çš„è„šæœ¬ä¼šæœ‰å¼ºç¼“å­˜åœ¨ï¼Œæ‰€ä»¥å®é™…è¡¨ç°ä¸Šæ˜¯ä¸ä¸€å®šè°ä¼šå…ˆæ‰§è¡Œï¼Œä½†æ˜¯è¿™ç§ä¸ç¨³å®šçš„æƒ…å†µæˆ‘ä»¬æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ï¼Œè‚¯å®šåšä¸åˆ°`document-start`ç›®æ ‡ã€‚å®é™…ä¸Šå…‰ä»è¿™ç‚¹æ¥çœ‹`v3`å¹¶ä¸æˆç†Ÿï¼Œå¾ˆå¤šèƒ½åŠ›çš„æ”¯æŒéƒ½ä¸åˆ°ä½ï¼Œæ‰€ä»¥åœ¨åæ¥å®˜æ–¹ä¹Ÿæ˜¯åšå‡ºäº†ä¸€äº›æ–¹æ¡ˆæ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰ä»€ä¹ˆåŠæ³•å†³å®šç”¨æˆ·å®¢æˆ·ç«¯çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œæ‰€ä»¥å¾ˆå¤šå…¼å®¹æ–¹æ³•è¿˜æ˜¯éœ€è¦å¤„ç†çš„ã€‚

```js
export const implantScript = () => {
  /**  RUN INJECT SCRIPT IN DOCUMENT START **/
  // #IFDEF CHROMIUM
  // https://bugs.chromium.org/p/chromium/issues/detail?id=634381
  // https://stackoverflow.com/questions/75495191/chrome-extension-manifest-v3-how-to-use-window-addeventlistener
  if (cross.scripting && cross.scripting.registerContentScripts) {
    logger.info("Register Inject Scripts By Scripting API");
    // https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/registerContentScripts
    cross.scripting
      .registerContentScripts([
        {
          matches: [...URL_MATCH],
          runAt: "document_start",
          world: "MAIN",
          allFrames: true,
          js: [process.env.INJECT_FILE + ".js"],
          id: process.env.INJECT_FILE,
        },
      ])
      .catch(err => {
        logger.warning("Register Inject Scripts Failed", err);
      });
  } else {
    logger.info("Register Inject Scripts By Tabs API");
    // https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated
    cross.tabs.onUpdated.addListener((_, changeInfo, tab) => {
      if (changeInfo.status == "loading") {
        const tabId = tab && tab.id;
        const tabURL = tab && tab.url;
        if (tabURL && !URL_MATCH.some(match => new RegExp(match).test(tabURL))) {
          return void 0;
        }
        if (tabId && cross.scripting) {
          cross.scripting.executeScript({
            target: { tabId: tabId, allFrames: true },
            files: [process.env.INJECT_FILE + ".js"],
            injectImmediately: true,
          });
        }
      }
    });
  }
  // #ENDIF
  // #IFDEF GECKO
  logger.info("Register Inject Scripts By Content Script Inline Code");
  // #ENDIF
};
```

åœ¨`Chrome V109`ä¹‹åæ”¯æŒäº†`chrome.scripting.registerContentScripts`ï¼Œ`Chrome 111`æ”¯æŒäº†ç›´æ¥åœ¨`Manifest`ä¸­å£°æ˜`world: 'MAIN'`çš„è„šæœ¬ï¼Œä½†æ˜¯è¿™å…¶ä¸­çš„å…¼å®¹æ€§è¿˜æ˜¯éœ€è¦å¼€å‘è€…æ¥åšï¼Œç‰¹åˆ«æ˜¯å¦‚æœåŸæ¥çš„æµè§ˆå™¨ä¸æ”¯æŒ`world: 'MAIN'`ï¼Œé‚£ä¹ˆè¿™ä¸ªè„šæœ¬æ˜¯ä¼šè¢«å½“ä½œ`Content Script`å¤„ç†çš„ï¼Œå…³äºè¿™ç‚¹æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰ç‚¹éš¾ä»¥å¤„ç†ã€‚

## é™æ€èµ„æºå¤„ç†
è®¾æƒ³ä¸€ä¸‹æˆ‘ä»¬çš„å¾ˆå¤šèµ„æºå¼•ç”¨æ˜¯ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å¤„ç†çš„ï¼Œä¾‹å¦‚åœ¨`manifest.json`ä¸­çš„`icons`å¼•ç”¨ï¼Œæ˜¯å­—ç¬¦ä¸²å¼•ç”¨è€Œå¹¶ä¸åƒæˆ‘ä»¬çš„`Web`åº”ç”¨ä¸­ä¼šæ ¹æ®å®é™…è·¯å¾„å¼•ç”¨èµ„æºï¼Œé‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹èµ„æºæ˜¯ä¸ä¼šä½œä¸ºæ‰“åŒ…å·¥å…·å®é™…å¼•ç”¨çš„å†…å®¹çš„ï¼Œå…·ä½“è¡¨ç°æ˜¯å½“æˆ‘ä»¬ä¿®æ”¹èµ„æºæ—¶å¹¶ä¸ä¼šè§¦å‘æ‰“åŒ…å·¥å…·çš„`HMR`ã€‚

å› æ­¤ï¼Œå¯¹äºè¿™éƒ¨åˆ†å†…å®¹æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å°†å…¶å¹¶å…¥æ‰“åŒ…çš„ä¾èµ–ä¸­ï¼Œæ­¤å¤–è¿˜éœ€è¦å°†ç›¸å…³æ–‡ä»¶å¤åˆ¶åˆ°æ‰“åŒ…çš„ç›®æ ‡æ–‡ä»¶å¤¹ä¸­ã€‚è¿™å®é™…ä¸Šå¹¶ä¸æ˜¯ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œåªéœ€è¦æˆ‘ä»¬å®ç°æ’ä»¶æ¥å®Œæˆè¿™ä»¶äº‹å³å¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å¤„ç†çš„é™¤äº†å›¾ç‰‡ç­‰é™æ€èµ„æºå¤–ï¼Œè¿˜æœ‰`locales`ä½œä¸ºè¯­è¨€æ–‡ä»¶å¤„ç†ã€‚

```js
exports.FilesPlugin = class FilesPlugin {
  apply(compiler) {
    compiler.hooks.make.tap("FilesPlugin", compilation => {
      const resources = path.resolve("public/static");
      !compilation.contextDependencies.has(resources) &&
        compilation.contextDependencies.add(resources);
    });

    compiler.hooks.done.tapPromise("FilesPlugin", () => {
      const locales = path.resolve("public/locales/");
      const resources = path.resolve("public/static/");

      const folder = isGecko ? "build-gecko" : "build";
      const localesTarget = path.resolve(`${folder}/_locales/`);
      const resourcesTarget = path.resolve(`${folder}/static/`);

      return Promise.all([
        exec(`cp -r ${locales} ${localesTarget}`),
        exec(`cp -r ${resources} ${resourcesTarget}`),
      ]);
    });
  }
};
```

## ç”ŸæˆManifest
åœ¨å‰è¾¹æåˆ°çš„å¤„ç†é™æ€èµ„æºçš„é—®é¢˜ä¸Šï¼Œå¯¹äº`manifest.json`æ–‡ä»¶çš„ç”Ÿæˆä¸ŠåŒæ ·å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°†å…¶ä½œä¸º`contextDependencies`æ³¨å†Œåˆ°æ‰“åŒ…å·¥å…·ä¸Šã€‚æ­¤å¤–ï¼Œè¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬éœ€è¦å…¼å®¹çš„`Chromium`å’Œ`Gecko`å˜›ï¼Œæˆ‘ä»¬åœ¨å¤„ç†`manifest.json`æ—¶åŒæ ·éœ€è¦å¯¹å…¶è¿›è¡Œå…¼å®¹å¤„ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‚¯å®šä¸å¸Œæœ›æœ‰ä¸¤ä»½é…ç½®æ–‡ä»¶æ¥å®Œæˆè¿™ä»¶äº‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å€ŸåŠ©`ts-node`æ¥åŠ¨æ€ç”Ÿæˆ`manifest.json`ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å„ç§é€»è¾‘æ¥åŠ¨æ€åœ°å°†é…ç½®æ–‡ä»¶å†™å…¥äº†ã€‚

```js
exports.ManifestPlugin = class ManifestPlugin {
  constructor() {
    tsNode.register();
    this.manifest = path.resolve(`src/manifest/index.ts`);
  }

  apply(compiler) {
    compiler.hooks.make.tap("ManifestPlugin", compilation => {
      const manifest = this.manifest;
      !compilation.fileDependencies.has(manifest) && compilation.fileDependencies.add(manifest);
    });

    compiler.hooks.done.tapPromise("ManifestPlugin", () => {
      delete require.cache[require.resolve(this.manifest)];
      const manifest = require(this.manifest);
      const version = require(path.resolve("package.json")).version;
      manifest.version = version;
      const folder = isGecko ? "build-gecko" : "build";
      return writeFile(path.resolve(`${folder}/manifest.json`), JSON.stringify(manifest, null, 2));
    });
  }
};
```

```js
const __URL_MATCH__ = ["https://*/*", "http://*/*", "file://*/*"];

// Chromium
const __MANIFEST__: Record<string, unknown> = {
  manifest_version: 3,
  name: "Force Copy",
  version: "0.0.0",
  description: "Force Copy Everything",
  default_locale: "en",
  icons: {
    32: "./static/favicon.128.png",
    96: "./static/favicon.128.png",
    128: "./static/favicon.128.png",
  },
  // ...
  permissions: ["activeTab", "tabs", "scripting"],
  minimum_chrome_version: "88.0",
};

// Gecko
if (process.env.PLATFORM === "gecko") {
  __MANIFEST__.manifest_version = 2;
  // ...
  __MANIFEST__.permissions = ["activeTab", "tabs", ...__URL_MATCH__];
  __MANIFEST__.browser_specific_settings = {
    gecko: { strict_min_version: "91.1.0" },
    gecko_android: { strict_min_version: "91.1.0" },
  };

  delete __MANIFEST__.action;
  delete __MANIFEST__.host_permissions;
  delete __MANIFEST__.minimum_chrome_version;
  delete __MANIFEST__.web_accessible_resources;
}

module.exports = __MANIFEST__;
```

## äº‹ä»¶é€šä¿¡æ–¹æ¡ˆ
åœ¨æµè§ˆå™¨æ‹“å±•ä¸­æœ‰å¾ˆå¤šæ¨¡å—ï¼Œå¸¸è§çš„æ¨¡å—æœ‰`background/worker`ã€`popup`ã€`content`ã€`inject`ã€`devtools`ç­‰ï¼Œä¸åŒçš„æ¨¡å—å¯¹åº”ç€ä¸åŒçš„ä½œç”¨ï¼Œåä½œæ„æˆäº†æ’ä»¶çš„æ‰©å±•åŠŸèƒ½ã€‚é‚£ä¹ˆæ˜¾ç„¶ç”±äºå­˜åœ¨å„ç§æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±éœ€è¦å®Œæˆå…³è”æ¨¡å—çš„é€šä¿¡èƒ½åŠ›ã€‚

ç”±äºæ•´ä¸ªé¡¹ç›®éƒ½æ˜¯ç”±`TS`æ„å»ºçš„ï¼Œå› æ­¤æˆ‘ä»¬æ›´å¸Œæœ›å®ç°ç±»å‹å®Œå¤‡çš„é€šä¿¡æ–¹æ¡ˆï¼Œç‰¹åˆ«æ˜¯åœ¨åŠŸèƒ½å®ç°å¤æ‚çš„æ—¶å€™é™æ€çš„ç±»å‹æ£€æŸ¥èƒ½å¤Ÿå¸®æˆ‘ä»¬é¿å…å¾ˆå¤šé—®é¢˜ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘ä»¬å°±ä»¥`Popup`åˆ°`Content`ä¸ºä¾‹å¯¹æ•°æ®é€šä¿¡åšç»Ÿä¸€çš„æ–¹æ¡ˆï¼Œåœ¨æ‰©å±•ä¸­æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªéœ€è¦é€šä¿¡çš„æ¨¡å—è®¾è®¡ç›¸å…³çš„ç±»ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰é€šä¿¡çš„`key`å€¼ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦é€šè¿‡`type`æ¥å†³å®šæœ¬æ¬¡é€šä¿¡ä¼ é€’çš„ä¿¡æ¯ç±»å‹ï¼Œè€Œä¸ºäº†é˜²æ­¢å€¼å†²çªï¼Œæˆ‘ä»¬é€šè¿‡`reduce`ä¸ºæˆ‘ä»¬çš„`key`å€¼å¢åŠ ä¸€äº›å¤æ‚åº¦ã€‚

```js
const PC_REQUEST_TYPE = ["A", "B"] as const;
export const POPUP_TO_CONTENT_REQUEST = PC_REQUEST_TYPE.reduce(
  (acc, cur) => ({ ...acc, [cur]: `__${cur}__${MARK}__` }),
  {} as { [K in typeof PC_REQUEST_TYPE[number]]: `__${K}__${typeof MARK}__` }
);
```

å¦‚æœæˆ‘ä»¬ç”¨è¿‡`redux`çš„è¯ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯`type`å¦‚ä½•è·Ÿ`payload`æºå¸¦çš„ç±»å‹å¯¹é½ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸Œæœ›å½“`type`æ˜¯`A`çš„æ—¶å€™ï¼Œ`TS`èƒ½å¤Ÿè‡ªåŠ¨æ¨æ–­å‡ºæ¥`payload`çš„ç±»å‹æ˜¯`{ x: number }`ï¼Œè€Œå¦‚æœ`type`æ˜¯`B`çš„æ—¶å€™ï¼Œ`TS`èƒ½å¤Ÿè‡ªåŠ¨æ¨æ–­ç±»å‹ä¸º`{ y: string }`ï¼Œé‚£ä¹ˆè¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•çš„å£°æ˜å¼æ–¹æ¡ˆå¦‚ä¸‹:

```js
type Tuple =
  | {
      type: "A";
      payload: { x: number };
    }
  | {
      type: "B";
      payload: { y: string };
    };
    
const pick = (data: Tuple) => {
  switch (data.type) {
    case "A":
      return data.payload.x; // number
    case "B":
      return data.payload.y; // string
  }
};
```

è¿™ä¹ˆå†™èµ·æ¥å®é™…ä¸Šå¹¶ä¸ä¼˜é›…ï¼Œæˆ‘ä»¬å¯èƒ½æ›´å¸Œæœ›å¯¹äºç±»å‹çš„å£°æ˜å¯ä»¥ä¼˜é›…ä¸€äº›ï¼Œé‚£ä¹ˆå½“ç„¶æˆ‘ä»¬å¯ä»¥å€ŸåŠ©èŒƒå‹æ¥å®Œæˆè¿™ä»¶äº‹ã€‚ä¸è¿‡æˆ‘ä»¬å¯èƒ½å¹¶ä¸èƒ½ä¸€æ­¥å°†å…¶å¤„ç†å®Œæˆï¼Œéœ€è¦åˆ†å¼€æŠŠç±»å‹å£°æ˜åšå¥½ï¼Œé¦–å…ˆæˆ‘ä»¬å¯ä»¥å®ç°`type -> payload`çš„ç±»å‹`Map`ï¼Œå°†æ˜ å°„å…³ç³»è¡¨è¾¾å‡ºæ¥ï¼Œä¹‹åå°†å…¶è½¬æ¢ä¸º`type -> { type: T, payload: Map[T] }`çš„ç»“æ„ï¼Œç„¶åå–`Tuple`å³å¯ã€‚

```js
type Map = {
  A: { x: number };
  B: { y: string };
};

type ToReflectMap<T extends string, M extends Record<string, unknown>> = {
  [P in T]: { type: unknown extends M[P] ? never : P; payload: M[P] };
};

type ReflectMap = ToReflectMap<keyof Map, Map>;

type Tuple = ReflectMap[keyof ReflectMap];
```

é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å¯ä»¥å°†å…¶å°è£…åˆ°ä¸€ä¸ª`namespace`ä¸­ï¼Œä»¥åŠä¸€äº›åŸºæœ¬çš„ç±»å‹æ•°æ®è½¬æ¢æ–¹æ³•æ¥æ–¹ä¾¿æˆ‘ä»¬è°ƒç”¨ã€‚

```js
export namespace Object {
  export type Keys<T extends Record<string, unknown>> = keyof T;

  export type Values<T extends Record<symbol | string | number, unknown>> = T[keyof T];
}

export namespace String {
  export type Map<T extends string> = { [P in T]: P };
}

export namespace EventReflect {
  export type Array<T, M extends Record<string, unknown>> = T extends string
    ? [type: unknown extends M[T] ? never : T, payload: M[T]]
    : never;

  export type Map<T extends string, M extends Record<string, unknown>> = {
    [P in T]: { type: unknown extends M[P] ? never : P; payload: M[P] };
  };

  export type Tuple<
    T extends Record<string, string>,
    M extends Record<string, unknown>
  > = Object.Values<Map<Object.Values<T>, M>>;
}

type Tuple = EventReflect.Tuple<String.Map<keyof Map>, Map>;
```

å®é™…ä¸Šä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬çš„å‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å‚æ•°åšå¤„ç†ï¼Œåœ¨å‡½æ•°å†…éƒ¨å°†å…¶é‡æ–°`as`ä¸ºéœ€è¦çš„å‚æ•°ç±»å‹å³å¯ã€‚

```js
type Map = {
  A: { x: number };
  B: { y: string };
};

type Args = EventReflect.Array<keyof Map, Map>;

declare function post(...args: Args): null;

post("A", { x: 2 });
post("B", { y: "" });
```

ä¸ºäº†æ˜ç¡®æˆ‘ä»¬çš„ç±»å‹è¡¨è¾¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸ç”¨å‡½æ•°å‚æ•°çš„å½¢å¼æ¥è¡¨è¾¾ï¼Œä¾ç„¶ä½¿ç”¨å¯¹è±¡`type -> payload`çš„å½¢å¼æ ‡æ³¨ç±»å‹ã€‚é‚£ä¹ˆæ—¢ç„¶åœ¨è¿™é‡Œæˆ‘ä»¬å·²ç»å°†è¯·æ±‚çš„ç±»å‹å®šä¹‰å¥½ï¼Œæˆ‘ä»¬æ¥ç€éœ€è¦å°†è¿”å›å“åº”çš„æ•°æ®ç±»å‹å®šä¹‰å‡ºæ¥ï¼Œä¸ºäº†æ–¹ä¾¿äºæ•°æ®çš„è¡¨è¾¾ä¸ä¸¥æ ¼çš„ç±»å‹ï¼Œæˆ‘ä»¬åŒæ ·å°†è¿”å›çš„æ•°æ®è¡¨ç¤ºä¸º`type -> payload`çš„å½¢å¼ï¼Œå½“ç„¶è¿™é‡Œçš„å“åº”`type`å’Œè¯·æ±‚æ—¶çš„`type`æ˜¯ä¸€è‡´çš„ã€‚


```js
type EventMap = {
  [POPUP_TO_CONTENT_REQUEST.A]: { [K in PCQueryAType]: boolean };
};

export type PCResponseType = EventReflect.Tuple<String.Map<keyof EventMap>, EventMap>;
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å®šä¹‰æ•´ä¸ªäº‹ä»¶é€šä¿¡çš„`Bridge`ï¼Œç”±äºæ­¤æ—¶æˆ‘ä»¬æ˜¯`Popup`å‘`Content`å‘é€æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»è¦æ˜ç¡®å‘å½“å‰çš„å“ªä¸ª`Tab`å‘é€æ•°æ®ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œéœ€è¦æŸ¥è¯¢å½“å‰æ´»è·ƒçš„`Tab`ã€‚æ•°æ®é€šä¿¡çš„æ–¹å¼åˆ™æ˜¯ä½¿ç”¨çš„`cross.tabs.sendMessage`æ–¹æ³•ï¼Œåœ¨æ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™åˆ™éœ€è¦`cross.runtime.onMessage.addListener`ã€‚å¹¶ä¸”ç”±äºå¯èƒ½å­˜åœ¨çš„å¤šç§é€šä¿¡é€šé“ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ¤æ–­è¿™ä¸ªæ¶ˆæ¯æºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡å‘é€çš„`key`åˆ¤æ–­å³å¯ã€‚

åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å³ä½¿æ‰©å±•çš„å®šä¹‰ä¸­`sendResponse`æ˜¯å“åº”å¼‚æ­¥æ•°æ®ï¼Œä½†æ˜¯åœ¨å®é™…æµ‹è¯•çš„è¿‡ç¨‹ä¸­å‘ç°è¿™ä¸ªå‡½æ•°æ˜¯ä¸èƒ½å¼‚æ­¥è°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå‡½æ•°å¿…é¡»è¦åœ¨å“åº”çš„å›è°ƒä¸­ç«‹å³æ‰§è¡Œï¼Œå…¶è¯´çš„å¼‚æ­¥æŒ‡çš„æ˜¯æ•´ä¸ªäº‹ä»¶é€šä¿¡çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä»¥æ•°æ®è¿”å›å“åº”çš„å½¢å¼æ¥å®šä¹‰ã€‚

```js
export class PCBridge {
  public static readonly REQUEST = POPUP_TO_CONTENT_REQUEST;

  static async postToContent(data: PCRequestType) {
    return new Promise<PCResponseType | null>(resolve => {
      cross.tabs
        .query({ active: true, currentWindow: true })
        .then(tabs => {
          const tab = tabs[0];
          const tabId = tab && tab.id;
          const tabURL = tab && tab.url;
          if (tabURL && !URL_MATCH.some(match => new RegExp(match).test(tabURL))) {
            resolve(null);
            return void 0;
          }
          if (!isEmptyValue(tabId)) {
            cross.tabs.sendMessage(tabId, data).then(resolve);
          } else {
            resolve(null);
          }
        })
        .catch(error => {
          logger.warning("Send Message Error", error);
        });
    });
  }

  static onPopupMessage(cb: (data: PCRequestType) => void | PCResponseType) {
    const handler = (
      request: PCRequestType,
      _: chrome.runtime.MessageSender,
      sendResponse: (response: PCResponseType | null) => void
    ) => {
      const response = cb(request);
      response && response.type === request.type && sendResponse(response);
    };
    cross.runtime.onMessage.addListener(handler);
    return () => {
      cross.runtime.onMessage.removeListener(handler);
    };
  }

  static isPCRequestType(data: PCRequestType): data is PCRequestType {
    return data && data.type && data.type.endsWith(`__${MARK}__`);
  }
}
```


æ­¤å¤–ï¼Œåœ¨`content`ä¸­ä¸`inject`é€šä¿¡éœ€è¦æ¯”è¾ƒç‰¹æ®Šçš„å°è£…ï¼Œåœ¨`Content Script`ä¸­çš„`DOM`å’Œäº‹ä»¶æµæ˜¯ä¸`Inject Script`å…±äº«çš„ï¼Œé‚£ä¹ˆå®é™…ä¸Šæˆ‘ä»¬å°±å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼å®ç°é€šä¿¡:
* é¦–å…ˆæˆ‘ä»¬å¸¸ç”¨çš„æ–¹æ³•æ˜¯`window.addEventListener + window.postMessage`ï¼Œåªä¸è¿‡è¿™ç§æ–¹å¼å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªé—®é¢˜æ˜¯åœ¨`Web`é¡µé¢ä¸­ä¹Ÿå¯ä»¥æ”¶åˆ°æˆ‘ä»¬çš„æ¶ˆæ¯ï¼Œå³ä½¿æˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€äº›éšæœºçš„`token`æ¥éªŒè¯æ¶ˆæ¯çš„æ¥æºï¼Œä½†æ˜¯è¿™ä¸ªæ–¹å¼æ¯•ç«Ÿèƒ½å¤Ÿéå¸¸ç®€å•åœ°è¢«é¡µé¢æœ¬èº«æˆªè·ä¸å¤Ÿå®‰å…¨ã€‚
* å¦ä¸€ç§æ–¹å¼å³`document.addEventListener + document.dispatchEvent + CustomEvent`è‡ªå®šä¹‰äº‹ä»¶çš„æ–¹å¼ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯äº‹ä»¶åè¦éšæœºï¼Œé€šè¿‡åœ¨æ³¨å…¥æ¡†æ¶æ—¶äº`background`ç”Ÿæˆå”¯ä¸€çš„éšæœºäº‹ä»¶åï¼Œä¹‹ååœ¨`Content Script`ä¸`Inject Script`éƒ½ä½¿ç”¨è¯¥äº‹ä»¶åé€šä¿¡ï¼Œå°±å¯ä»¥é˜²æ­¢ç”¨æˆ·æˆªè·æ–¹æ³•è°ƒç”¨æ—¶äº§ç”Ÿçš„æ¶ˆæ¯äº†ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰ä¼ è¾“çš„æ•°æ®ç±»å‹å¿…é¡»è¦æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå¦‚æœä¸æ˜¯å¯åºåˆ—åŒ–çš„è¯åœ¨`Gecko`å†…æ ¸çš„æµè§ˆå™¨ä¸­ä¼šè¢«è®¤ä¸ºæ˜¯è·¨åŸŸçš„å¯¹è±¡ï¼Œæ¯•ç«Ÿå®é™…ä¸Šç¡®å®æ˜¯è·¨è¶Šäº†ä¸åŒçš„`Context`äº†ï¼Œå¦åˆ™å°±ç›¸å½“äºç›´æ¥å…±äº«å†…å­˜äº†ã€‚

```js
// Content Script
document.addEventListener("xxxxxxxxxxxxx" + "content", e => {
    console.log("From Inject Script", e.detail);
});

// Inject Script
document.addEventListener("xxxxxxxxxxxxx" + "inject", e => {
    console.log("From Content Script", e.detail);
});

// Inject Script
document.dispatchEvent(
    new CustomEvent("xxxxxxxxxxxxx" + "content", {
        detail: { message: "call api" },
    }),
);

// Content Script
document.dispatchEvent(
    new CustomEvent("xxxxxxxxxxxxx" + "inject", {
        detail: { message: "return value" },
    }),
);
```


## çƒ­æ›´æ–°æ–¹æ¡ˆ
åœ¨å‰è¾¹æˆ‘ä»¬ä¸€ç›´æåˆ°äº†è°·æ­Œå¼ºæ¨çš„`v3`æœ‰å¾ˆå¤šé™åˆ¶ï¼Œè¿™å…¶ä¸­æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é™åˆ¶æ˜¯å…¶`CSP - Content Security Policy`ä¸å†å…è®¸åŠ¨æ€æ‰§è¡Œä»£ç ï¼Œé‚£ä¹ˆè¯¸å¦‚æˆ‘ä»¬`DevServer`çš„`HMR`å·¥å…·åˆ™éƒ½æ— æ³•æ­£å¸¸å‘æŒ¥å…¶ä½œç”¨äº†ï¼Œä½†æ˜¯çƒ­æ›´æ–°æ˜¯æˆ‘ä»¬å®é™…éœ€è¦çš„åŠŸèƒ½ï¼Œæ‰€ä»¥åªèƒ½é‡‡ç”¨å¹¶æ²¡æœ‰é‚£ä¹ˆå®Œå–„çš„è§£å†³æ–¹æ¡ˆã€‚

æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæ‰“åŒ…å·¥å…·çš„æ’ä»¶ï¼Œåˆ©ç”¨`ws.Server`å¯åŠ¨ä¸€ä¸ª`WebSocket`æœåŠ¡å™¨ï¼Œä¹‹ååœ¨`worker.js`ä¹Ÿå°±æ˜¯æˆ‘ä»¬å°†è¦å¯åŠ¨çš„`Service Worker`æ¥è¿æ¥`WebSocket`æœåŠ¡å™¨ã€‚ç„¶åå¯ä»¥é€šè¿‡`new WebSocket`æ¥é“¾æ¥å¹¶ä¸”åœ¨ç›‘å¬æ¶ˆæ¯ï¼Œå½“æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„`reload`æ¶ˆæ¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œ`chrome.runtime.reload()`æ¥å®ç°æ’ä»¶çš„é‡æ–°åŠ è½½äº†ã€‚

é‚£ä¹ˆåœ¨å¼€å¯çš„`WebSocket`æœåŠ¡å™¨ä¸­éœ€è¦åœ¨æ¯æ¬¡ç¼–è¯‘å®Œæˆä¹‹åä¾‹å¦‚`afterDone`è¿™ä¸ª`hook`å‘å®¢æˆ·ç«¯å‘é€`reload`æ¶ˆæ¯ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„æ’ä»¶é‡æ–°åŠ è½½èƒ½åŠ›äº†ã€‚ä½†æ˜¯å®é™…ä¸Šè¿™å¼•å…¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨`v3`ç‰ˆæœ¬çš„`Service Worker`ä¸ä¼šå¸¸é©»ï¼Œæ‰€ä»¥è¿™ä¸ª`WebSocket`é“¾æ¥ä¹Ÿä¼šéšç€`Service Worker`çš„é”€æ¯è€Œé”€æ¯ï¼Œæ˜¯æ¯”è¾ƒå‘çš„ä¸€ç‚¹ï¼ŒåŒæ ·ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸€ç‚¹å¤§é‡çš„`Chrome`æ‰©å±•æ— æ³•ä»`v2`å¹³æ»‘è¿‡æ¸¡åˆ°`v3`ï¼Œæ‰€ä»¥è¿™ä¸ªèƒ½åŠ›åç»­è¿˜æœ‰å¯èƒ½ä¼šè¢«æ”¹å–„ã€‚

```js
exports.ReloadPlugin = class ReloadPlugin {
  constructor() {
    if (isDev) {
      try {
        const server = new WebSocketServer({ port: 3333 });
        server.on("connection", client => {
          wsClient && wsClient.close();
          wsClient = client;
          console.log("Client Connected");
        });
      } catch (error) {
        console.log("Auto Reload Server Error", error);
      }
    }
  }
  apply(compiler) {
    compiler.hooks.afterDone.tap("ReloadPlugin", () => {
      wsClient && wsClient.send("reload-app");
    });
  }
};
```

```js
export const onReceiveReloadMsg = () => {
  if (__DEV__) {
    try {
      const ws = new WebSocket("ws://localhost:3333");
      // æ”¶åˆ°æ¶ˆæ¯å³é‡è½½
      ws.onmessage = () => {
        try {
          CWBridge.postToWorker({ type: CWBridge.REQUEST.RELOAD, payload: null });
        } catch (error) {
          logger.warning("SEND MESSAGE ERROR", error);
        }
      };
    } catch (error) {
      logger.warning("CONNECT ERROR", error);
    }
  }
};

export const onContentMessage = (data: CWRequestType, sender: chrome.runtime.MessageSender) => {
  logger.info("Worker Receive Content Message", data);
  switch (data.type) {
    case CWBridge.REQUEST.RELOAD: {
      reloadApp(RELOAD_APP);
      break;
    }
    // ...
  }
  return null;
};

```


## Popupå¤šè¯­è¨€
æ¯”è¾ƒæœ‰è¶£çš„ä¸€ä»¶äº‹æƒ…æ˜¯ï¼Œæµè§ˆå™¨æä¾›çš„å¤šè¯­è¨€æ–¹æ¡ˆå®é™…ä¸Šå¹¶ä¸å¥½ç”¨ï¼Œæˆ‘ä»¬åœ¨`locals`ä¸­å­˜å‚¨çš„æ–‡ä»¶å®é™…ä¸Šåªæ˜¯å ä½ï¼Œæ˜¯ä¸ºäº†è®©æ‰©å±•å¸‚åœºè®¤è¯†æˆ‘ä»¬çš„æµè§ˆå™¨æ‰©å±•æ”¯æŒçš„è¯­è¨€ï¼Œè€Œå®é™…ä¸Šçš„å¤šè¯­è¨€åˆ™åœ¨æˆ‘ä»¬çš„`Popup`ä¸­è‡ªè¡Œå®ç°ï¼Œä¾‹å¦‚åœ¨`packages/force-copy/public/locales/zh_CN`ä¸­çš„æ•°æ®å¦‚ä¸‹:

```js
{
  "name": {
    "message": "Force Copy"
  }
}
```

é‚£ä¹ˆå®é™…ä¸Šå‰ç«¯çš„å¤šè¯­è¨€è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œåœ¨è¿™é‡Œå› ä¸ºæˆ‘ä»¬çš„æ‰©å±•ç¨‹åºä¸ä¼šæœ‰å¤ªå¤šéœ€è¦å…³æ³¨çš„å¤šè¯­è¨€çš„å†…å®¹ï¼Œæ¯•ç«Ÿåªæ˜¯ä¸€ä¸ª`Popup`å±‚ï¼Œå¦‚æœéœ€è¦ç‹¬ç«‹ä¸€ä¸ª`index.html`çš„é¡µé¢çš„è¯ï¼Œé‚£é‡‡ç”¨ç¤¾åŒºçš„å¤šè¯­è¨€æ–¹æ¡ˆè¿˜æ˜¯æœ‰å¿…è¦çš„ã€‚ä¸è¿‡åœ¨è¿™é‡Œæˆ‘ä»¬å°±ç®€å•å®ç°å³å¯ã€‚

é¦–å…ˆæ˜¯ç±»å‹å®Œå¤‡ï¼Œåœ¨æˆ‘ä»¬çš„æ‹“å±•ä¸­æˆ‘ä»¬æ˜¯ä»¥è‹±æ–‡ä¸ºåŸºå‡†è¯­è¨€ï¼Œæ‰€ä»¥é…ç½®ä¹Ÿæ˜¯ä»¥è‹±æ–‡ä¸ºåŸºå‡†çš„è®¾ç½®ã€‚è€Œç”±äºæˆ‘ä»¬å¸Œæœ›æœ‰æ›´å¥½çš„åˆ†ç»„æ–¹æ¡ˆï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨æ¯”è¾ƒæ·±å±‚æ¬¡çš„åµŒå¥—ç»“æ„ï¼Œå› æ­¤ç±»å‹ä¸Šä¹Ÿå¿…é¡»å®Œæ•´å°†å…¶æ‹¼æ¥å‡ºæ¥ï¼Œç”¨ä»¥æ”¯æŒæˆ‘ä»¬çš„å¤šè¯­è¨€ã€‚

```js
export const en = {
  Title: "Force Copy",
  Captain: {
    Modules: "Modules",
    Start: "Start",
    Once: "Once",
  },
  Operation: {
    Copy: "Copy",
    Keyboard: "Keyboard",
    ContextMenu: "ContextMenu",
  },
  Information: {
    GitHub: "GitHub",
    Help: "Help",
    Reload: "Reload",
  },
};
```

```js
export type DefaultI18nConfig = typeof en;

export type ConfigBlock = {
  [key: string]: string | ConfigBlock;
};
type FlattenKeys<T extends ConfigBlock, Key = keyof T> = Key extends string
  ? T[Key] extends ConfigBlock
    ? `${Key}.${FlattenKeys<T[Key]>}`
    : `${Key}`
  : never;
export type I18nTypes = Record<FlattenKeys<DefaultI18nConfig>, string>;
```


ç´§æ¥ç€æˆ‘ä»¬å®šä¹‰`I18n`ç±»ä»¥åŠè¯­è¨€çš„å…¨å±€ç¼“å­˜ï¼Œåœ¨`I18n`ç±»ä¸­å®ç°äº†å‡½æ•°è°ƒç”¨ã€å¤šè¯­è¨€é…ç½®æŒ‰éœ€ç”Ÿæˆã€å¤šè¯­è¨€é…ç½®è·å–çš„å‡½æ•°ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™ç›´æ¥å®ä¾‹åŒ–`new I18n(cross.i18n.getUILanguage());`ï¼Œå–`i18n.t("Information.GitHub")`å³å¯ã€‚

```js
const cache: Record<string, I18nTypes> = {};

export class I18n {
  private config: I18nTypes;
  constructor(language: string) {
    this.config = I18n.getFullConfig(language);
  }

  t = (key: keyof I18nTypes, defaultValue = "") => {
    return this.config[key] || defaultValue || key;
  };

  private static getFullConfig = (key: string) => {
    if (cache[key]) return cache[key];
    let config;
    if (key.toLowerCase().startsWith("zh")) {
      config = this.generateFlattenConfig(zh);
    } else {
      config = this.generateFlattenConfig(en);
    }
    cache[key] = config;
    return config;
  };

  private static generateFlattenConfig = (config: ConfigBlock): I18nTypes => {
    const target: Record<string, string> = {};
    const dfs = (obj: ConfigBlock, prefix: string[]) => {
      for (const [key, value] of Object.entries(obj)) {
        if (isString(value)) {
          target[[...prefix, key].join(".")] = value;
        } else {
          dfs(value, [...prefix, key]);
        }
      }
    };
    dfs(config, []);
    return target as I18nTypes;
  };
}
```

## æœ€å
æµè§ˆå™¨æ‰©å±•çš„å¼€å‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ä¸€ä»¶äº‹ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å…¼å®¹`v2`å’Œ`v3`çš„æƒ…å†µä¸‹ï¼Œå¾ˆå¤šè®¾è®¡éƒ½éœ€è¦æ€è€ƒæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸åœ¨`v3`ä¸Šå®ç°ï¼Œåœ¨`v3`çš„æµè§ˆå™¨æ‰©å±•ä¸Šå¤±å»äº†å¾ˆå¤šçµæ´»æ€§ï¼Œä½†æ˜¯ç›¸å¯¹ä¹Ÿè·å–äº†ä¸€å®šçš„å®‰å…¨æ€§ã€‚ä¸è¿‡æµè§ˆå™¨æ‰©å±•æœ¬è´¨ä¸Šçš„æƒé™è¿˜æ˜¯ç›¸å½“é«˜çš„ï¼Œä¾‹å¦‚å³ä½¿æ˜¯`v3`æˆ‘ä»¬ä»ç„¶å¯ä»¥åœ¨`Chrome`ä¸Šä½¿ç”¨`CDP - ChromeÂ DevTools Protocol`æ¥å®ç°å¾ˆå¤šäº‹æƒ…ï¼Œæ‰©å±•èƒ½åšçš„ä¸œè¥¿å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå¦‚æœä¸äº†è§£æˆ–è€…ä¸å¼€æºçš„è¯æ ¹æœ¬ä¸æ•¢å®‰è£…ï¼Œå› ä¸ºæ‰©å±•æƒé™å¤ªé«˜å¯èƒ½ä¼šé€ æˆå¾ˆä¸¥é‡çš„ä¾‹å¦‚ç”¨æˆ·ä¿¡æ¯æ³„æ¼ç­‰é—®é¢˜ï¼Œå³ä½¿æ˜¯æ¯”å¦‚åƒ`Firefox`é‚£æ ·å¿…é¡»è¦ä¸Šä¼ æºä»£ç çš„æ–¹å¼æ¥åŠ å¼ºå®¡æ ¸ï¼Œä¹Ÿå¾ˆéš¾æœç»æ‰€æœ‰çš„éšæ‚£ã€‚


