# 初探富文本之划词评论能力
当我们实现在线文档平台时，划词评论的功能是非常必要的，特别是在重文档管理流程的在线文档产品中，文档反馈是非常重要的一环，这样可以帮助文档维护者提高文档质量。而即使是单纯的将划词评论作为讨论区，也是非常有用的，尤其是在文档并不那么完善的情况下，对接产品系统的时候可以得到文档之外的输入。那么本文将通过引入协同算法来解决冲突，从而实现在线文档的划词评论能力。

## 描述
实际上实现划词评论在交互上并不是非常困难的事，我们可以先简单设想一下，无非是在文档中选中文本，然后在`onMouseUp`事件唤醒评论的按钮，当用户点击按钮时输入评论的内容，然后将评论的位置和数据传输到持久化存储即可。在这里不禁让我想起来了一个著名的问题，把大象放进冰箱需要几步？答案是三步：把冰箱门打开，把大象放进去，把冰箱门关上。而把长颈鹿放进冰箱需要四步：把冰箱门打开，把大象拿出来，把长颈鹿放进去，把冰箱门关上。

我们的划词评论也很像将大象放进冰箱的步骤，那么这个问题难点究竟是什么，很明显我们不容易找到评论的位置，如果此时不是富文本编辑器的话，我们可以考虑一种方案，即将`DOM`的具体层级存储起来，也就是保存一个路径数组，在渲染以及`Resize`的时候将其重新查找并计算即可。当然如果情况允许的话，对于每个文本节点都放置一个`id`，然后持久化的时候存储`id`和`offset`即可，只不过通常不太容易具备这种条件，入侵性太强且可能需要改造数据`->`渲染的存储结构，也就是说这个`id`是需要幂等地渲染，即多次渲染不会改变`id`，这样对于数据的存储也是额外增加了负担，当然如果对于位置计算比较复杂的话，这种空间换时间的实现也是可取的。

那么对于静态的内容，我们可能有很多办法来解决划词位置的持久化问题，而我们的在线文档是动态的内容，我们需要考虑到文档的变更，而文档内容的变更就有可能影响到划词位置的改变。例如原本划词的位置是`[2, 6]`，而此时在`0`位置上加入了文本或者图片等内容，此时如果还保持着`[2, 6]`的位置，那么划词的位置就不正确了，所以我们需要引入协同算法来解决这个问题，相当于`follow`文档的变更，重新计算划词的位置。请注意，在这里我们讨论的是非协同场景下的划词评论能力，如果此时文档系统已经引入了在线协同编辑的能力，那么基本就不需要考虑位置的计算问题，此时我们可以直接将后端同样作为一个协同编辑的客户端，直接使用协同算法来解决位置变换的问题。

## OT


## CRDT


## 每日一题

```
https://github.com/WindrunnerMax/EveryDay
```

## 参考

```
https://quilljs.com/docs/delta
https://docs.yjs.dev/api/relative-positions
https://www.npmjs.com/package/quill-delta/v/4.2.2
```
